<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ë¥¶Âè∑Áä∂ÊÄÅÈù¢Êùø</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    />
    <!-- ÂºïÂÖ• OTPAuth Â∫ìÁî®‰∫éÁîüÊàêÈ™åËØÅÁ†Å -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.2.1/otpauth.umd.min.js"></script>
    <style>
      :root {
        --bg: #f8f9fa;
        --ink: #111827;
        --ink-soft: #6b7280;
        --accent: #f97316; /* Ê©ôËâ≤‰∏ªË∞É */
        --accent-hover: #ea580c;
        --accent-subtle: #fff7ed;
        --card: #ffffff;
        --border: #e5e7eb;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff;
        
        /* Áä∂ÊÄÅÈ¢úËâ≤ */
        --status-idle-bg: #f3f4f6; --status-idle-text: #4b5563;
        --status-checking-bg: #fff7ed; --status-checking-text: #c2410c;
        --status-qualified-bg: #ecfdf5; --status-qualified-text: #059669;
        --status-invalid-bg: #fef2f2; --status-invalid-text: #dc2626;
        --highlight: rgba(249, 115, 22, 0.08);

        --radius: 8px;
      }

      html[data-theme="dark"] {
        --bg: #0f172a;
        --ink: #f3f4f6;
        --ink-soft: #9ca3af;
        --accent: #fb923c;
        --accent-hover: #fdba74;
        --accent-subtle: #431407;
        --card: #1e293b;
        --border: #334155;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        --input-bg: #0f172a;
        
        --status-idle-bg: #374151; --status-idle-text: #9ca3af;
        --status-checking-bg: #431407; --status-checking-text: #fb923c;
        --status-qualified-bg: #064e3b; --status-qualified-text: #34d399;
        --status-invalid-bg: #450a0a; --status-invalid-text: #f87171;
        --highlight: rgba(251, 146, 60, 0.15);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background: var(--bg);
        height: 100vh;
        overflow: hidden;
        font-size: 13px;
        -webkit-font-smoothing: antialiased;
      }

      /* Icons */
      .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
      .icon-sm { width: 14px; height: 14px; stroke-width: 2; }

      /* Layout */
      header {
        height: 64px;
        padding: 0 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--border);
        background: var(--card);
        justify-content: space-between;
      }

      .title-section { display: flex; align-items: center; gap: 12px; }
      .title { margin: 0; font-size: 18px; font-weight: 700; color: var(--ink); display: flex; align-items: center; gap: 8px; letter-spacing: -0.02em; }
      .subtitle { margin: 0; color: var(--ink-soft); font-size: 12px; display: none; }
      @media (min-width: 1024px) { .subtitle { display: block; border-left: 1px solid var(--border); padding-left: 12px; } }

      .layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: calc(100vh - 64px);
        background: var(--bg);
      }

      /* Panels */
      .panel-left {
        background: var(--card);
        border-right: 1px solid var(--border);
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .panel-right {
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* Typography & Headers */
      h2 {
        margin: 0 0 12px;
        font-size: 12px;
        font-weight: 600;
        color: var(--ink-soft);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Forms */
      .field { margin-bottom: 12px; }
      label { display: block; font-size: 12px; font-weight: 500; color: var(--ink); margin-bottom: 6px; }
      
      input, select, textarea {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--border);
        color: var(--ink);
        padding: 8px 10px;
        border-radius: var(--radius);
        font-size: 13px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      input:focus, select:focus, textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--highlight);
      }
      ::placeholder { color: var(--ink-soft); opacity: 0.5; }

      /* Custom Input Group */
      .input-group { display: flex; gap: 0; }
      .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
      .input-group button { border-top-left-radius: 0; border-bottom-left-radius: 0; height: auto; }

      /* Components */
      .card-box {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
      }
      .radio-group { display: flex; gap: 16px; align-items: center; padding: 4px 0; }
      .radio-group label { margin: 0; font-weight: 400; display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--ink-soft); }
      .radio-group input:checked + span { color: var(--ink); font-weight: 500; }

      /* Buttons */
      button {
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: var(--radius);
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.15s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        line-height: 1;
      }
      /* Primary */
      button:not(.secondary):not(.ghost):not(.cat-btn) {
        background: var(--accent);
        color: white;
      }
      button:not(.secondary):not(.ghost):not(.cat-btn):hover {
        background: var(--accent-hover);
      }
      button:not(.secondary):not(.ghost):not(.cat-btn):active {
        transform: translateY(1px);
      }
      /* Secondary */
      button.secondary {
        background: var(--input-bg);
        border-color: var(--border);
        color: var(--ink);
      }
      button.secondary:hover {
        background: var(--bg);
        border-color: var(--ink-soft);
      }
      /* Ghost (Transparent) */
      button.ghost {
        background: transparent;
        color: var(--ink-soft);
        padding: 6px;
      }
      button.ghost:hover {
        background: var(--bg);
        color: var(--ink);
      }
      button.ghost.danger:hover {
        color: var(--status-invalid-text);
        background: var(--status-invalid-bg);
      }

      /* Icons only button class */
      button.icon-btn {
        padding: 6px;
        width: 28px;
        height: 28px;
        border-radius: 6px;
      }

      /* Summary Stats */
      .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 0; }
      .stat-item {
        background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
        padding: 10px; text-align: center; box-shadow: var(--shadow);
      }
      .stat-label { font-size: 11px; color: var(--ink-soft); text-transform: uppercase; display: block; margin-bottom: 4px; }
      .stat-val { font-size: 18px; font-weight: 700; color: var(--ink); line-height: 1; }

      /* Top Toolbar (Filter & Actions) */
      .table-toolbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; background: var(--card); padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius); }
      
      .cat-bar { display: flex; gap: 4px; }
      .cat-btn { background: transparent; color: var(--ink-soft); padding: 6px 10px; font-size: 12px; border-radius: 6px; }
      .cat-btn[data-active="true"] { background: var(--accent-subtle); color: var(--accent); font-weight: 600; }
      .cat-btn:hover:not([data-active="true"]) { background: var(--bg); color: var(--ink); }

      .actions-grp { display: flex; gap: 4px; align-items: center; }
      .divider { width: 1px; height: 16px; background: var(--border); margin: 0 4px; }

      /* Table */
      .table-container { 
        flex: 1; 
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: var(--radius); 
        overflow: hidden; 
        display: flex; flex-direction: column;
        box-shadow: var(--shadow);
      }
      .table-scroll { overflow: auto; flex: 1; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      thead th { 
        position: sticky; top: 0; background: var(--bg); z-index: 10; 
        text-align: left; padding: 10px 12px; font-weight: 600; color: var(--ink-soft); 
        border-bottom: 1px solid var(--border); 
      }
      td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--ink); vertical-align: middle; }
      tr:hover td { background: var(--highlight); }
      tr.row-editing td { background: var(--status-checking-bg); }

      .status-chip { 
        display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; 
        font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; 
      }
      .status-chip.IDLE { background: var(--status-idle-bg); color: var(--status-idle-text); }
      .status-chip.CHECKING { background: var(--status-checking-bg); color: var(--status-checking-text); }
      .status-chip.QUALIFIED { background: var(--status-qualified-bg); color: var(--status-qualified-text); }
      .status-chip.INVALID { background: var(--status-invalid-bg); color: var(--status-invalid-text); }
      .status-chip.PRODUCT { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }

      .mono-text { font-family: "JetBrains Mono", monospace; letter-spacing: -0.5px; }
      .action-cell { display: flex; justify-content: flex-end; gap: 4px; }

      /* 1Key Widget */
      .onekey-box {
        display: flex; flex-direction: column; align-items: flex-end;
        border-right: 1px solid var(--border); padding-right: 16px; margin-right: 16px;
      }
      .onekey-val { font-size: 14px; font-weight: 700; color: var(--status-qualified-text); }
      .onekey-label { font-size: 10px; color: var(--ink-soft); }

      /* Responsive */
      @media (max-width: 900px) {
        .layout { grid-template-columns: 1fr; height: auto; display: block; }
        .panel-left { height: auto; border-right: none; border-bottom: 1px solid var(--border); }
        .table-toolbar { flex-direction: column; align-items: stretch; }
        .cat-bar { overflow-x: auto; padding-bottom: 4px; }
        body { overflow-y: auto; }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="title-section">
        <svg class="icon" style="color:var(--accent);" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
        <h1 class="title"><span data-i18n="title">Account Pulse</span></h1>
        <p class="subtitle" data-i18n="subtitle">API Status Monitor</p>
      </div>

      <div style="display:flex; align-items:center;">
        <!-- OneKey Rate Widget -->
        <div id="onekeyRateBox" class="onekey-box">
           <div id="onekeyRate" class="onekey-val">--</div>
           <div class="onekey-label">1Key Rate</div>
           <div id="onekeyStats" style="display:none"></div>
        </div>

        <div style="display:flex; gap:8px;">
           <button id="themeToggle" class="secondary icon-btn" title="Switch Theme"></button>
           <div style="display:flex; border:1px solid var(--border); border-radius: var(--radius); padding:2px;">
             <button id="langZh" class="ghost" style="padding:4px 8px; font-size:11px;" data-lang="zh">CN</button>
             <button id="langEn" class="ghost" style="padding:4px 8px; font-size:11px;" data-lang="en">EN</button>
           </div>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- Left Panel: Controls -->
      <section class="panel-left">
        <!-- Import -->
        <div>
          <h2 data-i18n="import_title"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> ÂØºÂÖ•‰∏éÂà∑Êñ∞</h2>
          
          <div class="card-box">
             <div class="field">
                <input id="file" type="file" accept=".txt" multiple style="margin-bottom:4px;"/>
                <div id="fileHint" style="font-size: 11px; color: var(--ink-soft); text-align:right;"></div>
             </div>
             
             <div class="field" style="display:flex; justify-content:space-between; align-items:center;">
                <div class="radio-group">
                  <label><input type="radio" name="mode" value="OVERWRITE" checked /><span data-i18n="mode_overwrite">Ë¶ÜÁõñ</span></label>
                  <label><input type="radio" name="mode" value="APPEND" /><span data-i18n="mode_append">ËøΩÂä†</span></label>
                </div>
                <div id="modeHint" style="font-size: 10px; color: var(--status-invalid-text);"></div>
             </div>
             <button id="importBtn" style="width: 100%;">
                <span data-i18n="import_btn">ÂºÄÂßãÂØºÂÖ•</span>
             </button>
          </div>
          
          <div style="margin-top:12px; display:flex; gap:8px;">
            <div class="input-group" style="flex:1;">
               <input id="refreshSeconds" type="number" min="1" value="5" title="Refresh Seconds" />
               <button id="applyRefresh" class="secondary" data-i18n="apply_refresh">Set</button>
            </div>
            <button id="toggleAutoRefresh" class="secondary icon-btn" title="Auto Refresh" style="width:auto; padding:0 12px;">
                <span data-i18n="auto_refresh_on">Auto: On</span>
            </button>
          </div>
          
          <div style="margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
             <button id="manualRefresh" class="secondary"><span data-i18n="manual_refresh">Âà∑Êñ∞</span></button>
             <button id="resetChecking" class="secondary"><span data-i18n="reset_checking">ÈáçÁΩÆ</span></button>
          </div>
          <div id="message" style="margin-top:8px; min-height:16px; font-size:11px; text-align:center;"></div>
        </div>

        <!-- 2FA Tool -->
        <div>
          <h2><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> 2FA ËÆ°ÁÆóÂô®</h2>
          <div class="card-box" style="border-left: 3px solid var(--ink-soft);">
            <input id="twofaSecret" placeholder="Paste Secret Key" style="font-family:'JetBrains Mono'; margin-bottom:8px;"/>
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <div class="timer" style="font-size:10px; color:var(--ink-soft);">Refesh in <span id="twofaCountdown" style="font-weight:700;">30</span>s</div>
               <div id="totpCode" class="mono-text" style="font-size:18px; font-weight:700; color:var(--accent); cursor:pointer;">--- ---</div>
            </div>
            <div id="twofaStatus" style="text-align:right; font-size:10px; color:var(--ink-soft); margin-top:2px;">Click to copy</div>
          </div>
        </div>

        <!-- OneKey Tool -->
        <div>
          <h2><svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> OneKey Batch</h2>
          <div class="card-box" style="border-left: 3px solid var(--accent);">
            <input id="onekeyApiKey" type="password" placeholder="hCaptcha API Key (Optional)" style="margin-bottom:8px; font-size:11px;"/>
            <textarea id="onekeyIds" rows="2" placeholder="verificationId (one per line)" style="resize:none; margin-bottom:8px;"></textarea>
            <div style="display:flex; gap:6px; margin-bottom:8px;">
              <input id="onekeyProgramId" placeholder="programId" style="flex:1; font-size:11px;" />
              <label style="font-size:11px; display:flex; align-items:center; cursor:pointer;"><input id="onekeyUseLucky" type="checkbox"/> Lucky</label>
            </div>
            <button id="onekeyBatchBtn" class="secondary" style="width:100%; border-style:dashed;" data-i18n="onekey_btn">Verify</button>
            <div id="onekeyResult" style="margin-top:6px; font-size:10px; color:var(--ink-soft); word-break:break-all;"></div>
          </div>
        </div>
      </section>

      <!-- Right Panel: Data -->
      <section class="panel-right">
        <!-- Stats Summary -->
        <div id="summary" class="stats-grid"></div>

        <div class="table-toolbar">
           <!-- Category Tabs -->
           <div class="cat-bar" id="categoryBar">
              <button class="cat-btn" data-cat="ALL" data-active="true" data-i18n="cat_all">ÂÖ®ÈÉ®</button>
              <button class="cat-btn" data-cat="CHECKING" data-i18n="cat_checking">Ê£ÄÊµã‰∏≠</button>
              <button class="cat-btn" data-cat="QUALIFIED" data-i18n="cat_qualified">ËµÑË¥®</button>
              <button class="cat-btn" data-cat="INVALID" data-i18n="cat_invalid">Êó†Êïà</button>
              <button class="cat-btn" data-cat="FINISHED" data-i18n="cat_finished">ÊàêÂìÅ</button>
              <button class="cat-btn" data-cat="IDLE" data-i18n="cat_idle">IDLE</button>
           </div>
           
           <!-- Batch Actions -->
           <div class="actions-grp">
              <span id="selectedCount" style="font-size:11px; color:var(--ink-soft); margin-right:4px;"></span>
              <button id="exportSelectedBtn" class="ghost icon-btn" title="Export Selected"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
              <button id="resetSelectedBtn" class="ghost icon-btn" title="Reset Selected"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg></button>
              <button id="setProductSelectedBtn" class="ghost icon-btn" title="Set to Product"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></button>
              <div class="divider"></div>
              <button id="deleteSelectedBtn" class="ghost danger icon-btn" title="Delete Selected"><svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
              <button id="clearSelectionBtn" class="ghost icon-btn" title="Clear Selection"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>
              
              <div class="divider"></div>
              <button id="toggleSheeridView" class="secondary" style="height:28px; padding:0 10px; font-size:11px;">
                <span data-i18n="view_sheerid">ÂàáÊç¢ËßÜÂõæ</span>
              </button>
           </div>
        </div>

        <!-- Table View -->
        <div id="accountsView" class="table-container">
           <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width: 40px; text-align: center;"><input id="selectAll" type="checkbox" /></th>
                  <th data-i18n="th_email">Ë¥¶Âè∑</th>
                  <th data-i18n="th_password">ÂØÜÁ†Å</th>
                  <th data-i18n="th_2fa">2FA Token</th>
                  <th data-i18n="th_status" style="width:100px;">Áä∂ÊÄÅ</th>
                  <th data-i18n="th_sold" style="text-align:center; width:60px;">ÂîÆÂá∫</th>
                  <th style="text-align: right; width:80px;"></th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
           </div>
        </div>

        <!-- SheerID View (Hidden by default) -->
        <div id="sheeridView" class="table-container" style="display:none;">
           <div style="padding:12px; background:var(--status-checking-bg); font-size:12px; border-bottom:1px solid var(--border);" data-i18n="sheerid_desc">Showing QUALIFIED accounts with links only.</div>
           <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th_email">Ë¥¶Âè∑</th>
                    <th data-i18n="th_sheerid">ËÆ§ËØÅÈìæÊé•</th>
                    <th data-i18n="th_verify_status">È™åËØÅÁä∂ÊÄÅ</th>
                    <th style="text-align:right;">Action</th>
                  </tr>
                </thead>
                <tbody id="sheeridTableBody"></tbody>
              </table>
           </div>
        </div>
      </section>
    </main>

    <!-- JS Logic -->
    <script>
      /* --- Icons Definitions --- */
      const ICONS = {
        sun: `<svg viewBox="0 0 24 24" class="icon"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        moon: `<svg viewBox="0 0 24 24" class="icon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        export: `<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
        trash: `<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
        check: `<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        x: `<svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
        play: `<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`
      };

      const messageEl = document.getElementById("message");
      const fileInput = document.getElementById("file");
      const fileHintEl = document.getElementById("fileHint");
      const modeHintEl = document.getElementById("modeHint");
      const importBtn = document.getElementById("importBtn");
      const applyRefreshBtn = document.getElementById("applyRefresh");
      const manualRefreshBtn = document.getElementById("manualRefresh");
      const resetCheckingBtn = document.getElementById("resetChecking");
      const refreshSecondsInput = document.getElementById("refreshSeconds");
      const tableBody = document.getElementById("tableBody");
      const toggleSheeridViewBtn = document.getElementById("toggleSheeridView");
      const accountsViewEl = document.getElementById("accountsView");
      const sheeridViewEl = document.getElementById("sheeridView");
      const sheeridTableBody = document.getElementById("sheeridTableBody");
      const summaryEl = document.getElementById("summary");
      const selectedCountEl = document.getElementById("selectedCount");
      const selectAllEl = document.getElementById("selectAll");
      const exportSelectedBtn = document.getElementById("exportSelectedBtn");
      const resetSelectedBtn = document.getElementById("resetSelectedBtn");
      const setProductSelectedBtn = document.getElementById("setProductSelectedBtn");
      const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
      const clearSelectionBtn = document.getElementById("clearSelectionBtn");
      const themeToggleBtn = document.getElementById("themeToggle");
      
      let refreshTimer = null;
      let currentLang = "zh";
      let editingEmail = null;
      let lastAccounts = [];
      const selectedEmails = new Set();
      let currentCategory = "ALL";

      const i18n = {
        zh: {
          page_title: "Ë¥¶Âè∑Áä∂ÊÄÅÈù¢Êùø",
          title: "Account Pulse",
          subtitle: "ÂØºÂÖ•Ë¥¶Âè∑TXTÊñá‰ª∂ÔºåÁõëÊéßAPIÁä∂ÊÄÅÂèòÂåñ„ÄÇ",
          import_title: "ÂØºÂÖ•‰∏éÂà∑Êñ∞",
          file_label: "TXT Êñá‰ª∂",
          file_hint_none: "Êú™ÈÄâÊã©Êñá‰ª∂",
          file_hint_count: (n) => `Â∑≤ÈÄâ ${n} ‰∏™`,
          mode_label: "ÂØºÂÖ•Ê®°Âºè",
          mode_overwrite: "Ë¶ÜÁõñ",
          mode_append: "ËøΩÂä†",
          mode_overwrite_disabled: "DBÊ®°ÂºèÁ¶ÅÁî®Ë¶ÜÁõñ",
          import_btn: "ÂºÄÂßãÂØºÂÖ•",
          cat_all: "ÂÖ®ÈÉ®",
          cat_checking: "Ê£ÄÊµã‰∏≠",
          cat_qualified: "ËµÑË¥®Âè∑",
          cat_invalid: "Â§±ÊïàÂè∑",
          cat_finished: "ÊàêÂìÅÂè∑",
          cat_idle: "Á©∫Èó≤",
          onekey_title: "OneKey ÊâπÈáèÈ™åËØÅ",
          onekey_btn: "ÊâπÈáèÈ™åËØÅ",
          view_sheerid: "Êü•ÁúãÈìæÊé•",
          view_accounts: "ËøîÂõûÂàóË°®",
          sheerid_desc: "‰ªÖÊòæÁ§∫Â∑≤ÈÄöËøáËµÑË¥®ÔºàQUALIFIEDÔºâ‰∏îÊúâÈìæÊé•ÁöÑË¥¶Âè∑„ÄÇ",
          // ... (Messages simplified for brevity) ...
          msg_import_done: (a, u, s) => `Êñ∞Â¢û ${a}, Êõ¥Êñ∞ ${u}, Ë∑≥Ëøá ${s}`,
          msg_import_fail: "ÂØºÂÖ•Â§±Ë¥•",
          msg_status_updated: "Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞",
          theme_dark: "üåô", theme_light: "‚òÄÔ∏è",
          empty_table: "ÊöÇÊó†Êï∞ÊçÆ", empty_sheerid: "ÊöÇÊó†ÈìæÊé•",
          // Table Headers
          th_email: "Ë¥¶Âè∑", th_password: "ÂØÜÁ†Å", th_2fa: "2FA", th_status: "Áä∂ÊÄÅ", th_sold: "Âá∫ÂîÆ", th_actions: "",
          th_sheerid: "ËÆ§ËØÅÈìæÊé•", th_verify_status: "È™åËØÅÁªìÊûú",
          verify_btn: "È™åËØÅ", delete_btn: "Âà†Èô§",
          // ... copy rest of keys as needed or fallback to defaults
          msg_delete_confirm: "Á°ÆËÆ§Âà†Èô§Ê≠§Ë¥¶Âè∑Ôºü",
          msg_delete_done: "Â∑≤Âà†Èô§", msg_delete_fail: "Âà†Èô§Â§±Ë¥•",
          msg_cell_copied: "Â∑≤Â§çÂà∂", msg_cell_copy_fail: "Â§çÂà∂Â§±Ë¥•",
          auto_refresh_on: "Auto: On", auto_refresh_off: "Auto: Off",
          manual_refresh: "Âà∑Êñ∞", reset_checking: "ÈáçÁΩÆÁä∂ÊÄÅ", apply_refresh: "ËÆæÁΩÆ",
          summary_total: "ÊÄªÊï∞", summary_idle: "IDLE", summary_checking: "Ê£ÄÊü•‰∏≠", summary_qualified: "ËµÑË¥®", summary_invalid: "Êó†Êïà"
        },
        en: {
          page_title: "Account Pulse", title: "Account Pulse", subtitle: "Monitor API Status",
          import_title: "Import", input_label: "TXT Input",
          mode_overwrite: "Overwrite", mode_append: "Append",
          cat_all: "All", cat_checking: "Checking", cat_qualified: "Qualified", cat_invalid: "Invalid", cat_finished: "Finished", cat_idle: "Idle",
          view_sheerid: "Links View", view_accounts: "List View",
          onekey_btn: "Verify",
          th_email: "Account", th_password: "Password", th_2fa: "2FA", th_status: "Status", th_sold: "Sold",
          verify_btn: "Verify", delete_btn: "Del",
          msg_import_done: (a, u, s) => `+${a}, ~${u}, -${s}`,
          msg_import_fail: "Failed",
          empty_table: "No Data",
          msg_delete_confirm: "Delete permanently?",
          msg_delete_done: "Deleted",
          msg_cell_copied: "Copied",
          auto_refresh_on: "Auto: ON", auto_refresh_off: "Auto: OFF",
          manual_refresh: "Refresh", reset_checking: "Reset", apply_refresh: "Set"
        }
      };

      function setMessage(text, tone = "info") {
        messageEl.textContent = text;
        messageEl.style.color = tone === "error" ? "var(--status-invalid-text)" : "var(--status-qualified-text)";
        setTimeout(() => { if(messageEl.textContent === text) messageEl.textContent = ""; }, 3000);
      }

      function getCurrentTheme() { return document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light"; }
      function setTheme(theme, persist = true) {
        if (theme === "dark") document.documentElement.setAttribute("data-theme", "dark");
        else document.documentElement.removeAttribute("data-theme");
        if (persist) localStorage.setItem("theme", theme);
        themeToggleBtn.innerHTML = theme === "dark" ? ICONS.moon : ICONS.sun;
      }

      function getCurrentStatusView() { return (localStorage.getItem("status_view") || "ACCOUNTS").toUpperCase(); }
      function setStatusView(view, persist = true) {
        const v = view === "SHEERID" ? "SHEERID" : "ACCOUNTS";
        if (persist) localStorage.setItem("status_view", v);
        if (v === "SHEERID") {
          accountsViewEl.style.display = "none"; sheeridViewEl.style.display = "flex";
          toggleSheeridViewBtn.querySelector("span").textContent = i18n[currentLang].view_accounts;
        } else {
          accountsViewEl.style.display = "flex"; sheeridViewEl.style.display = "none";
          toggleSheeridViewBtn.querySelector("span").textContent = i18n[currentLang].view_sheerid;
        }
        renderActiveView();
      }

      async function copyText(text) {
        try { await navigator.clipboard.writeText(text); return true; } catch { return false; }
      }

      /* Data Filters & Views */
      function getFilteredAccounts() {
        const list = Array.isArray(lastAccounts) ? lastAccounts : [];
        if (currentCategory === "ALL") return list;
        if (currentCategory === "FINISHED") return list.filter(a => a.status === "PRODUCT");
        return list.filter(a => a.status === currentCategory);
      }

      function updateSelectionUI() {
        const sel = selectedEmails.size;
        selectedCountEl.textContent = sel > 0 ? `${sel} Selected` : "";
        const total = getFilteredAccounts().length;
        selectAllEl.checked = total > 0 && sel === total;
        selectAllEl.indeterminate = sel > 0 && sel < total;
      }

      function renderSummary(counts, total) {
        const t = i18n[currentLang];
        // Short summary at top
        const items = [
          { l: "TOTAL", v: total },
          { l: "CHECKING", v: counts.CHECKING || 0 },
          { l: "QUALIFIED", v: counts.QUALIFIED || 0 },
          { l: "PRODUCT", v: (lastAccounts.filter(a => a.status === "PRODUCT").length) }
        ];
        summaryEl.innerHTML = items.map(i => `<div class="stat-item"><span class="stat-label">${i.l}</span><span class="stat-val">${i.v}</span></div>`).join("");
      }

      function renderActiveView() {
        getCurrentStatusView() === "SHEERID" ? renderSheeridTable(lastAccounts.filter(a => a.status === "QUALIFIED" && a.sheeridUrl)) : renderTable(getFilteredAccounts());
      }

      /* MAIN TABLE RENDER */
      function renderTable(accounts) {
        if (!accounts || accounts.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--ink-soft);">${i18n[currentLang].empty_table}</td></tr>`;
          updateSelectionUI(); return;
        }

        // Clean obsolete selections
        const currentSet = new Set(accounts.map(a => a.email));
        [...selectedEmails].forEach(e => { if(!currentSet.has(e)) selectedEmails.delete(e); });
        updateSelectionUI();

        tableBody.innerHTML = accounts.map(acc => {
          const isEdit = editingEmail === acc.email;
          const statusClass = `status-chip ${acc.status}`;
          
          if (isEdit) {
            return `<tr data-email="${acc.email}" class="row-editing">
               <td style="text-align:center;"><input type="checkbox" disabled /></td>
               <td>${acc.email}</td>
               <td><input class="edit-password" value="${(acc.password||"").replaceAll('"','&quot;')}" /></td>
               <td><input class="edit-2fa" value="${(acc.authenticatorToken||"").replaceAll('"','&quot;')}" /></td>
               <td><select class="edit-status">
                  ${["IDLE","CHECKING","QUALIFIED","INVALID","PRODUCT"].map(s => `<option value="${s}" ${s === acc.status ? "selected":""}>${s}</option>`).join("")}
               </select></td>
               <td><input type="checkbox" ${acc.sold?"checked":""} disabled/></td>
               <td class="action-cell">
                  <button class="ghost edit-save icon-btn" data-email="${acc.email}" style="color:var(--status-qualified-text);">${ICONS.check}</button>
                  <button class="ghost edit-cancel icon-btn" data-email="${acc.email}">${ICONS.x}</button>
               </td>
            </tr>`;
          }
          return `<tr data-email="${acc.email}">
             <td style="text-align:center;"><input type="checkbox" class="row-select" data-email="${acc.email}" ${selectedEmails.has(acc.email)?"checked":""} /></td>
             <td class="copyable" data-copy-type="email" title="Copy">${acc.email}</td>
             <td class="copyable" data-copy-type="password" title="Copy">***</td>
             <td class="copyable mono-text" data-copy-type="token" title="Copy">${acc.authenticatorToken || ""}</td>
             <td class="status-cell" data-email="${acc.email}"><span class="${statusClass}">${acc.status}</span></td>
             <td style="text-align:center;"><input type="checkbox" class="sold-toggle" data-email="${acc.email}" ${acc.sold?"checked":""}/></td>
             <td class="action-cell">
                <button class="ghost export-btn icon-btn" data-email="${acc.email}" title="Copy Line">${ICONS.export}</button>
                <button class="ghost danger delete-btn icon-btn" data-email="${acc.email}" title="Delete">${ICONS.trash}</button>
             </td>
          </tr>`;
        }).join("");

        // Attach Events
        bindTableEvents();
      }

      function renderSheeridTable(accounts) {
        if (!accounts.length) { sheeridTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">${i18n[currentLang].empty_sheerid}</td></tr>`; return; }
        sheeridTableBody.innerHTML = accounts.map(a => {
           const url = (a.sheeridUrl||"").trim();
           const verifyId = (url.match(/([a-f0-9]{24})/i) || [])[1] || "";
           return `<tr data-email="${a.email}">
             <td>${a.email}</td>
             <td class="copyable sheerid-cell" data-copy-type="sheerid" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${url}</td>
             <td class="verify-status" data-email="${a.email}" style="color:var(--ink-soft);">-</td>
             <td class="action-cell">
               <button class="ghost sheerid-verify-btn icon-btn" data-verify-id="${verifyId}" data-email="${a.email}" title="Verify" ${!verifyId?'disabled':''} style="color:var(--accent);">${ICONS.play}</button>
               <button class="ghost danger sheerid-delete-btn icon-btn" data-email="${a.email}" title="Delete Link">${ICONS.trash}</button>
             </td>
           </tr>`
        }).join("");
        bindSheeridEvents();
      }

      /* Event Binding Helpers (Simplified) */
      function bindTableEvents() {
        // Selection
        tableBody.querySelectorAll(".row-select").forEach(el => el.addEventListener("change", e => {
           const em = e.target.dataset.email;
           e.target.checked ? selectedEmails.add(em) : selectedEmails.delete(em);
           updateSelectionUI();
        }));
        
        // Copy
        tableBody.querySelectorAll(".copyable").forEach(el => el.addEventListener("click", async ev => {
           ev.stopPropagation();
           const type = el.dataset.copyType;
           const row = el.closest("tr");
           let txt = el.textContent;
           
           if(type === 'token') {
             // ÁÇπÂáª 2FA TokenÔºöÂ°´ÂÖ•ËÆ°ÁÆóÂô®Âπ∂Áõ¥Êé•ËÆ°ÁÆóÈ™åËØÅÁ†Å
             const acc = lastAccounts.find(a => a.email === row.dataset.email);
             if(acc && acc.authenticatorToken) {
               const secretInput = document.getElementById("twofaSecret");
               if(secretInput) {
                 secretInput.value = acc.authenticatorToken;
                 secretInput.dispatchEvent(new Event("input")); // Êõ¥Êñ∞ËÆ°ÁÆóÂô®ÊòæÁ§∫
               }
               // Áõ¥Êé•ËÆ°ÁÆóÈ™åËØÅÁ†Å
               try {
                 const totp = new OTPAuth.TOTP({ secret: OTPAuth.Secret.fromBase32(acc.authenticatorToken.replace(/\s/g, '').toUpperCase()) });
                 const code = totp.generate();
                 copyText(code).then(() => setMessage("È™åËØÅÁ†ÅÂ∑≤Â§çÂà∂: " + code));
               } catch(e) {
                 setMessage("Token Ê†ºÂºèÈîôËØØ", "error");
               }
             }
             return;
           }
           
           if(type === 'password') { // retrieve literal password from data if hidden
             const acc = lastAccounts.find(a => a.email === row.dataset.email);
             if(acc) txt = acc.password; 
           }
           copyText(txt).then(ok => setMessage(ok ? i18n[currentLang].msg_cell_copied : "Error"));
        }));

        // Export Row
        tableBody.querySelectorAll(".export-btn").forEach(btn => btn.addEventListener("click", async e => {
           e.stopPropagation();
           const acc = lastAccounts.find(a => a.email === btn.dataset.email);
           if(acc) {
             const str = `|${acc.email}|${acc.password}|${acc.authenticatorToken}|`;
             if(await copyText(str)) setMessage("Line Copied");
           }
        }));

        // Delete Row
        tableBody.querySelectorAll(".delete-btn").forEach(btn => btn.addEventListener("click", async e => {
           e.stopPropagation();
           if(!confirm(i18n[currentLang].msg_delete_confirm)) return;
           try {
             await fetch("/api/delete", { method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({email: btn.dataset.email}) });
             setMessage(i18n[currentLang].msg_delete_done);
             fetchAccounts();
           } catch { setMessage("Failed", "error"); }
        }));

        // Sold Toggle
        tableBody.querySelectorAll(".sold-toggle").forEach(t => t.addEventListener("change", async e => {
           try { await fetch("/api/sold", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:t.dataset.email, sold:t.checked}) });
           } catch { t.checked = !t.checked; }
        }));

        // Double Click Edit
        tableBody.querySelectorAll("tr[data-email]").forEach(r => r.addEventListener("dblclick", e => {
           if(e.target.closest("button") || e.target.closest("input")) return;
           editingEmail = r.dataset.email;
           renderActiveView();
        }));

        // Edit Save/Cancel
        tableBody.querySelectorAll(".edit-cancel").forEach(b => b.addEventListener("click", (e) => { e.stopPropagation(); editingEmail = null; renderActiveView(); }));
        tableBody.querySelectorAll(".edit-save").forEach(b => b.addEventListener("click", async (e) => {
           e.stopPropagation();
           const r = b.closest("tr");
           const email = b.dataset.email;
           const pw = r.querySelector(".edit-password").value;
           const tok = r.querySelector(".edit-2fa").value;
           const stat = r.querySelector(".edit-status").value;
           
           try {
              // Save details via update/import
              await fetch("/api/import", { method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({mode:"APPEND", content:`${email};${pw};${tok}`})});
              // Save status
              await fetch("/api/status", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email, status: stat})});
              editingEmail = null;
              setMessage("Saved");
              fetchAccounts();
           } catch { setMessage("Error saving", "error"); }
        }));
      }

      function bindSheeridEvents() {
        // Similar copy logic
        sheeridTableBody.querySelectorAll(".copyable").forEach(el => el.addEventListener("click", () => copyText(el.textContent).then(() => setMessage("Copied"))));
        
        sheeridTableBody.querySelectorAll(".sheerid-delete-btn").forEach(btn => btn.addEventListener("click", async () => {
           if(!confirm("Delete link?")) return;
           await fetch("/api/sheerid", {  method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: btn.dataset.email, sheeridUrl: "" }) });
           fetchAccounts();
        }));

        sheeridTableBody.querySelectorAll(".sheerid-verify-btn").forEach(btn => btn.addEventListener("click", async () => {
           const vid = btn.dataset.verifyId;
           const statEl = btn.closest("tr").querySelector(".verify-status");
           statEl.textContent = "Verifying...";
           btn.disabled = true;
           try {
              await verifySheeridSSE([vid], (res) => {
                 if(res.status || res.message) statEl.textContent = res.status || res.message;
              });
           } catch(e) { statEl.textContent = "Error"; }
           btn.disabled = false;
        }));
      }

      /* Core Functions: Fetch, Import etc. (Logic kept identical to original just compacted) */
      async function fetchAccounts() {
        try {
           const res = await fetch("/api/accounts");
           if(!res.ok) throw new Error();
           const data = await res.json();
           lastAccounts = data.accounts || [];
           renderSummary(data.counts||{}, data.total||0);
           renderActiveView();
        } catch { setMessage("Fetch error", "error"); }
      }

      // Import
      importBtn.addEventListener("click", async () => {
         const files = Array.from(fileInput.files||[]);
         if(!files.length) return setMessage("No files", "error");
         importBtn.disabled = true; importBtn.textContent = "...";
         try {
            const mode = document.querySelector("input[name='mode']:checked").value;
            let added=0, updated=0, skipped=0;
            for (let i=0; i<files.length; i++) {
               const txt = await files[i].text();
               const m = (i===0)? mode : (mode==="OVERWRITE"?"APPEND":mode);
               const res = await fetch("/api/import", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({mode:m, content:txt}) });
               const j = await res.json();
               added += (j.added||0); updated += (j.updated||0); skipped += (j.skipped||0);
            }
            setMessage(i18n[currentLang].msg_import_done(added, updated, skipped));
            fetchAccounts();
         } catch { setMessage("Import Failed", "error"); }
         importBtn.disabled = false; importBtn.textContent = i18n[currentLang].import_btn;
      });
      // Import UI
      fileInput.addEventListener("change", () => fileHintEl.textContent = fileInput.files.length ? i18n[currentLang].file_hint_count(fileInput.files.length) : "");

      // Refresh Logic
      function scheduleRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        const sec = Number(refreshSecondsInput.value) || 5;
        fetchAccounts(); // Á´ãÂç≥Âä†ËΩΩ‰∏ÄÊ¨°
        refreshTimer = setInterval(fetchAccounts, sec * 1000);
      }
      applyRefreshBtn.addEventListener("click", () => { scheduleRefresh(); setMessage("Timer Set"); });
      manualRefreshBtn.addEventListener("click", fetchAccounts);
      document.getElementById("toggleAutoRefresh").addEventListener("click", function() {
         if(refreshTimer) { clearInterval(refreshTimer); refreshTimer=null; this.querySelector("span").textContent = i18n[currentLang].auto_refresh_off; this.style.opacity = "0.5"; }
         else { scheduleRefresh(); this.querySelector("span").textContent = i18n[currentLang].auto_refresh_on; this.style.opacity = "1"; }
      });
      resetCheckingBtn.addEventListener("click", async ()=> {
         if(confirm("Reset checking status?")) { await fetch("/api/reset-checking", {method:"POST"}); fetchAccounts(); }
      });

      // Batch Actions
      selectAllEl.addEventListener("change", () => {
         const list = getFilteredAccounts();
         if(selectAllEl.checked) list.forEach(a => selectedEmails.add(a.email));
         else list.forEach(a => selectedEmails.delete(a.email));
         renderActiveView();
      });
      clearSelectionBtn.addEventListener("click", () => { selectedEmails.clear(); renderActiveView(); });
      
      exportSelectedBtn.addEventListener("click", async () => {
         const list = lastAccounts.filter(a => selectedEmails.has(a.email));
         if(!list.length) return;
         const txt = list.map(a => `|${a.email}|${a.password}|${a.authenticatorToken}|`).join("\n");
         copyText(txt).then(() => setMessage("Batch Export Copied"));
      });
      
      deleteSelectedBtn.addEventListener("click", async () => {
         if(!selectedEmails.size || !confirm(`Delete ${selectedEmails.size} accounts?`)) return;
         for(let em of selectedEmails) await fetch("/api/delete", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email:em})});
         selectedEmails.clear(); fetchAccounts();
      });

      resetSelectedBtn.addEventListener("click", async () => {
         if(!selectedEmails.size || !confirm("Reset selected to IDLE?")) return;
         await fetch("/api/restore-statuses", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({items: [...selectedEmails].map(e=>({email:e, status:"IDLE"}))}) });
         fetchAccounts();
      });

      setProductSelectedBtn.addEventListener("click", async () => {
         if(!selectedEmails.size || !confirm("Set selected to PRODUCT?")) return;
         await fetch("/api/restore-statuses", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({items: [...selectedEmails].map(e=>({email:e, status:"PRODUCT"}))}) });
         fetchAccounts();
      });

      // 2FA Timer
      setInterval(() => {
        const sec = document.querySelector("#twofaSecret").value;
        const left = 30 - Math.floor((Date.now()/1000)%30);
        document.querySelector("#twofaCountdown").textContent = left;
        if(sec) {
           try {
             const totp = new OTPAuth.TOTP({algorithm:'SHA1',digits:6,period:30,secret:OTPAuth.Secret.fromBase32(sec.replace(/\s/g,''))});
             const code = totp.generate();
             document.querySelector("#totpCode").textContent = code.slice(0,3)+" "+code.slice(3);
           } catch { document.querySelector("#totpCode").textContent = "Ext Err"; }
        }
      }, 1000);
      document.querySelector("#totpCode").addEventListener("click", function(){ 
         copyText(this.textContent.replace(/\s/g,'')).then(()=>setMessage("Code Copied")); 
      });

      // OneKey 1Key Batch
      const onekeyApiKeyEl = document.getElementById("onekeyApiKey");
      onekeyApiKeyEl.value = localStorage.getItem("onekey_api_key") || "";
      onekeyApiKeyEl.addEventListener("change", () => localStorage.setItem("onekey_api_key", onekeyApiKeyEl.value.trim()));
      
      document.getElementById("onekeyBatchBtn").addEventListener("click", async () => {
         const ids = (document.getElementById("onekeyIds").value || "").split("\n").map(l=>(l.match(/([a-f0-9]{24})/i)||[])[1]).filter(Boolean);
         if(!ids.length) return setMessage("No IDs", "error");
         document.getElementById("onekeyResult").textContent = "Requesting...";
         
         const apiKey = onekeyApiKeyEl.value;
         const useLucky = document.getElementById("onekeyUseLucky").checked;
         const progId = document.getElementById("onekeyProgramId").value;
         
         try {
             const pRes = await fetch("https://batch.1key.me/", { mode:"cors", credentials:"omit" });
             const csrf = (await pRes.text()).match(/CSRF_TOKEN\s*=\s*"([^"]+)"/)?.[1];
             if(!csrf) throw new Error("No CSRF");

             const r = await fetch("https://batch.1key.me/api/batch", {
                method:"POST", headers:{"Content-Type":"application/json", "X-CSRF-Token":csrf},
                body: JSON.stringify({ verificationIds: ids, hCaptchaToken: apiKey, useLucky, programId: progId })
             });
             if(!r.ok) throw new Error("API Error");
             
             // Simple SSE Reader
             const reader = r.body.getReader();
             const dec = new TextDecoder();
             let out = "";
             while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value, {stream:true});
                chunk.split("\n").forEach(l => { if(l.startsWith("data:")) out += l.slice(5).trim() + "\n"; });
                document.getElementById("onekeyResult").textContent = out;
             }
         } catch(e) { document.getElementById("onekeyResult").textContent = "Err: "+e.message; }
      });

      // Init
      document.querySelectorAll(".lang-switch button").forEach(b => b.addEventListener("click", ()=> { currentLang=b.dataset.lang; renderActiveView(); }));
      document.querySelectorAll(".cat-btn").forEach(b => b.addEventListener("click", () => {
         currentCategory = b.dataset.cat;
         document.querySelectorAll(".cat-btn").forEach(btn => btn.setAttribute("data-active", btn===b));
         renderActiveView();
      }));
      themeToggleBtn.addEventListener("click", () => setTheme(getCurrentTheme()==="dark"?"light":"dark"));
      toggleSheeridViewBtn.addEventListener("click", () => {
        const next = getCurrentStatusView() === "SHEERID" ? "ACCOUNTS" : "SHEERID";
        setStatusView(next);
      });

      // Initial Load
      setTheme(localStorage.getItem("theme") || "light", false);
      setStatusView(getCurrentStatusView(), false); // ÂàùÂßãÂåñËßÜÂõæÁä∂ÊÄÅ
      applyRefreshBtn.click(); // Start default timer logic

      // OneKey Rate Monitor (Âª∂ËøüÂä†ËΩΩÔºå‰∏çÈòªÂ°ûË¥¶Âè∑)
      setTimeout(() => {
        rateMon();
        setInterval(rateMon, 60000);
      }, 2000);
      
      async function rateMon() {
         try {
            const d = await(await fetch("/api/onekey-status")).json();
            let p=0,f=0,c=0;
            (d.resultHistory||[]).forEach(x => { if(x.r===0)p++; else if(x.r===1)f++; else c++; });
            const rate = (p+f+c)?(p/(p+f+c)*100).toFixed(1):0;
            const el = document.getElementById("onekeyRate");
            el.textContent = rate+"%";
            el.style.color = rate>50 ? "var(--status-qualified-text)" : "var(--status-invalid-text)";
         } catch {}
      }

      // SSE Helpers
      async function verifySheeridSSE(vids, cb) {
         const res = await fetch("/api/sheerid-verify", { 
            method:"POST", headers:{"Content-Type":"application/json"}, 
            body:JSON.stringify({verificationIds:vids, apiKey: onekeyApiKeyEl.value}) 
         });
         const reader = res.body.getReader();
         const dec = new TextDecoder();
         while(true) {
            const {done,val} = await reader.read(); if(done)break;
            const lines = dec.decode(val,{stream:true}).split("\n");
            for(let l of lines) if(l.startsWith("data:")) try { cb(JSON.parse(l.slice(5))); } catch(e){ cb({message:l.slice(5)}); }
         }
      }
    </script>
  </body>
</html>