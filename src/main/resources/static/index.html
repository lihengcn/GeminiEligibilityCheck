<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è´¦å·çŠ¶æ€é¢æ¿</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
    />
    <!-- å¼•å…¥ OTPAuth åº“ç”¨äºç”ŸæˆéªŒè¯ç  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.2.1/otpauth.umd.min.js"></script>
    <style>
      :root {
        --bg: #f6f3ee;
        --ink: #1e1c18;
        --ink-soft: #6b645c;
        --accent: #d95d39; /* æ´»åŠ›æ©™çº¢ */
        --accent-hover: #b54728;
        --accent-2: #3d7d91; /* ç¨³é‡é’è“ */
        --accent-2-hover: #2c5d6e;
        --card: #ffffff;
        --card-border: rgba(30, 28, 24, 0.08);
        --shadow: 0 4px 20px rgba(30, 28, 24, 0.04);
        --line: rgba(30, 28, 24, 0.08);
        --bg-grad: radial-gradient(circle at top left, #fff1e3 0%, #f6f3ee 40%, #eef6f6 100%);
        --input-bg: #ffffff;
        --status-idle-bg: #f0f0f0; --status-idle-text: #666;
        --status-checking-bg: #fff4e5; --status-checking-text: #b76e00;
        --status-qualified-bg: #e3fcec; --status-qualified-text: #1b663e;
        --status-invalid-bg: #ffebeb; --status-invalid-text: #c92a2a;
        --highlight: rgba(217, 93, 57, 0.05);
      }

      html[data-theme="dark"] {
        --bg: #111111;
        --ink: #e0e0e0;
        --ink-soft: #999999;
        --accent: #ff7e5f;
        --accent-hover: #ff9e85;
        --accent-2: #5aaacc;
        --accent-2-hover: #7bc0dd;
        --card: #1c1c1c;
        --card-border: rgba(255, 255, 255, 0.08);
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        --line: rgba(255, 255, 255, 0.08);
        --bg-grad: radial-gradient(circle at top left, #2a1f1c 0%, #111111 40%, #151d21 100%);
        --input-bg: #252525;
        --status-idle-bg: #2d2d2d; --status-idle-text: #aaa;
        --status-checking-bg: #3d2e1e; --status-checking-text: #ffad42;
        --status-qualified-bg: #1c3628; --status-qualified-text: #6bdfa3;
        --status-invalid-bg: #3d1f1f; --status-invalid-text: #ff8080;
        --highlight: rgba(255, 126, 95, 0.1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, -apple-system, blinkmacsystemfont, "Segoe UI", roboto, sans-serif;
        color: var(--ink);
        background: var(--bg-grad);
        height: 100vh;
        overflow: hidden;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
      }

      /* SVG Icon åŸºç¡€æ ·å¼ */
      .icon {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
        vertical-align: text-bottom;
        flex-shrink: 0;
      }
      
      .icon-sm {
        width: 14px;
        height: 14px;
        stroke-width: 2.5;
        margin-right: 4px;
        vertical-align: middle;
      }

      /* æ»šåŠ¨æ¡ç¾åŒ– */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--ink-soft); opacity: 0.2; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--ink); }

      header {
        padding: 20px 24px 10px;
        height: 80px;
        display: flex;
        align-items: center;
      }

      .header-row {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
      }

      .title {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--ink) 0%, var(--ink-soft) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .subtitle {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--ink-soft);
      }

      .layout {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 20px;
        padding: 0 24px 24px;
        height: calc(100vh - 80px);
      }

      .panel {
        background: var(--card);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--card-border);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .input-panel { gap: 24px; }

      h2 {
        margin: 0 0 16px;
        font-size: 14px;
        font-weight: 700;
        color: var(--ink-soft);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid var(--line);
        padding-bottom: 8px;
      }

      h2 .icon {
        width: 20px;
        height: 20px;
        margin-top: -2px;
        color: var(--accent);
      }

      .controls { display: flex; flex-direction: column; gap: 16px; }
      .field { display: flex; flex-direction: column; gap: 8px; }

      label {
        font-size: 12px;
        font-weight: 600;
        color: var(--ink-soft);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      input[type="text"], input[type="number"], input[type="file"], textarea, select {
        background: var(--input-bg);
        border: 1px solid var(--line);
        color: var(--ink);
        padding: 10px 12px;
        border-radius: 8px;
        font-family: inherit;
        font-size: 13px;
        width: 100%;
        transition: all 0.2s;
        outline: none;
      }
      input[type="file"] { padding: 8px; cursor: pointer; }
      input:focus, textarea:focus, select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(217, 93, 57, 0.15);
      }

      .radio-group { font-family: inherit; display: flex; flex-direction: column; gap: 8px; background: var(--bg); padding: 10px; border-radius: 8px; }
      .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; text-transform: none; color: var(--ink); font-size: 13px; letter-spacing: normal; font-weight: 400; }

      button {
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-weight: 600;
        font-size: 13px;
        padding: 10px 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: auto;
      }

      button:not(.secondary) {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 4px 10px rgba(217, 93, 57, 0.3);
      }
      button:not(.secondary):hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(217, 93, 57, 0.4);
      }
      button.secondary {
        background: var(--bg);
        color: var(--ink);
        border: 1px solid var(--line);
      }
      button.secondary:hover {
        background: var(--line);
        border-color: var(--ink-soft);
      }
      button:active { transform: translateY(1px) !important; }

      /* å¡ç‰‡å¼åˆ†åŒº */
      .mini-card {
        background: var(--bg);
        border-radius: 12px;
        padding: 16px;
        border: 1px solid var(--line);
      }
      .mini-card h3 {
        margin: 0 0 8px;
        font-size: 13px;
        font-weight: 700;
        color: var(--accent-2);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .mini-card h3 .icon { width: 16px; height: 16px; }
      .mini-card p { margin: 0 0 12px; font-size: 12px; color: var(--ink-soft); line-height: 1.4; }

      .code-box {
        margin-top: 12px;
        background: var(--card);
        border: 2px dashed var(--line);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        transition: border-color 0.2s;
      }
      .code-box:hover { border-color: var(--accent); }

      .totp-display {
        font-family: "JetBrains Mono", monospace;
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
        letter-spacing: 4px;
        cursor: pointer;
        margin: 4px 0;
        user-select: all;
      }
      .totp-display:active { transform: scale(0.96); }
      .timer { font-size: 11px; color: var(--ink-soft); margin-bottom: 4px; }

      /* æ•°æ®é¢æ¿ */
      .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 20px; }
      .summary-card {
        background: var(--bg);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .summary-card span { font-size: 11px; color: var(--ink-soft); text-transform: uppercase; margin-bottom: 4px; }
      .summary-card strong { font-size: 20px; font-weight: 700; color: var(--ink); }

      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      thead { position: sticky; top: 0; background: var(--card); z-index: 10; box-shadow: 0 1px 0 var(--line); }
      th { text-align: left; padding: 12px 10px; font-weight: 600; color: var(--ink-soft); text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; }
      td { padding: 12px 10px; border-bottom: 1px solid var(--line); color: var(--ink); vertical-align: middle; }
      tr:hover td { background: var(--bg); }
      tr.row-editing td { background: var(--highlight); }

      .copyable { cursor: pointer; transition: color 0.1s; }
      .copyable:hover { color: var(--accent-2); text-decoration: underline; }

      .status-chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; }
      .status-chip.IDLE { background: var(--status-idle-bg); color: var(--status-idle-text); }
      .status-chip.CHECKING { background: var(--status-checking-bg); color: var(--status-checking-text); }
      .status-chip.QUALIFIED { background: var(--status-qualified-bg); color: var(--status-qualified-text); }
      .status-chip.INVALID { background: var(--status-invalid-bg); color: var(--status-invalid-text); }
      .status-chip.PRODUCT { background: rgba(212, 175, 55, 0.18); color: #8a6a00; border: 1px solid rgba(212, 175, 55, 0.38); }

      .category-bar { display: flex; background: var(--bg); padding: 4px; border-radius: 10px; gap: 4px; margin: 10px 0 16px; width: fit-content; }
      .cat-btn { background: transparent; border: none; color: var(--ink-soft); padding: 6px 16px; border-radius: 8px; font-size: 12px; box-shadow: none !important; }
      .cat-btn:hover { color: var(--ink); background: rgba(0,0,0,0.05); }
      .cat-btn[data-active="true"] { background: var(--card); color: var(--accent); font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important; }

      .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
      .toolbar-left { display: flex; gap: 8px; }
      .lang-switch { display: flex; gap: 8px; }
      .lang-switch button { padding: 8px 10px; font-size: 12px; border-radius: 6px; }

      @media (max-width: 900px) {
        .layout { grid-template-columns: 1fr; height: auto; overflow: visible; }
        .header-row { flex-direction: column; align-items: flex-start; }
        .panel { height: auto; min-height: 500px; }
        body { overflow-y: auto; height: auto; }
      }

      #message { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 12px; text-align: center; min-height: 20px; }
      
      /* Theme Toggle Icon Specifics */
      #themeToggle svg { width: 18px; height: 18px; }
    </style>
  </head>
  <body>
    <!-- SVG Definition Block (Used for reference or re-use if needed, but we use inline for simplicity) -->
    
    <header>
      <div class="header-row">
        <div>
          <h1 class="title">
            <svg class="icon" style="width:28px;height:28px;color:var(--accent);" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
            <span data-i18n="title">Account Pulse</span>
          </h1>
          <p class="subtitle" data-i18n="subtitle">å¯¼å…¥è´¦å· txt æ–‡ä»¶ï¼Œå®æ—¶æŸ¥çœ‹çŠ¶æ€å˜åŒ–ã€‚</p>
        </div>
        <div class="lang-switch">
          <button id="langZh" class="secondary" data-lang="zh">ä¸­æ–‡</button>
          <button id="langEn" class="secondary" data-lang="en">EN</button>
          <button id="themeToggle" class="secondary" type="button" aria-label="Toggle Theme">
            <!-- Icon is injected by JS -->
          </button>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <section class="panel input-panel">
        <div>
          <h2 data-i18n="import_title">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m16 16-4-4-4 4"></path></svg>
            å¯¼å…¥ä¸åˆ·æ–°
          </h2>
          <div class="controls">
            <div class="field">
              <label for="file">
                <span data-i18n="file_label">TXT æ–‡ä»¶</span>
              </label>
              <input id="file" type="file" accept=".txt" multiple />
              <div id="fileHint" style="font-size: 12px; color: var(--ink-soft); margin-top: 4px;"></div>
            </div>

            <div class="field">
              <label for="importTemplate" data-i18n="template_label">å¯¼å…¥æ¨¡æ¿</label>
              <select id="importTemplate">
                <option value="AUTO" data-i18n="template_auto">è‡ªåŠ¨è¯†åˆ«</option>
                <option value="TOKEN" data-i18n="template_token">è´¦å·;å¯†ç ;2FA å¯†é’¥</option>
                <option value="RECOVERY_EMAIL" data-i18n="template_recovery">è´¦å·;å¯†ç ;æ¢å¤é‚®ç®±</option>
              </select>
              <div id="templateHint" style="font-size: 11px; color: var(--ink-soft);"></div>
            </div>
            
            <div class="field">
              <label data-i18n="mode_label">å¯¼å…¥æ¨¡å¼</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="mode" value="OVERWRITE" checked />
                  <span data-i18n="mode_overwrite">è¦†ç›– (æ¸…ç©ºåå¯¼å…¥)</span>
                </label>
                <label>
                  <input type="radio" name="mode" value="APPEND" />
                  <span data-i18n="mode_append">è¿½åŠ  (ä¿ç•™å¹¶æ·»åŠ )</span>
                </label>
              </div>
              <div id="modeHint" style="font-size: 11px; color: var(--ink-soft);"></div>
            </div>
            
            <button id="importBtn" style="width: 100%;">
              <span data-i18n="import_btn">å¼€å§‹å¯¼å…¥</span>
            </button>
          </div>
        </div>

        <!-- 2FA å·¥å…· -->
        <div class="mini-card">
          <h3>
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <span data-i18n="twofa_title">äºŒæ­¥éªŒè¯ (2FA)</span>
          </h3>
          <p data-i18n="twofa_desc">è¾“å…¥å¯†é’¥ï¼Œè‡ªåŠ¨è®¡ç®—éªŒè¯ç ã€‚</p>
          
          <div class="field">
            <label for="twofaSecret">
              <span data-i18n="twofa_secret_label">å¯†é’¥ (Secret Key)</span>
            </label>
            <input
              id="twofaSecret"
              placeholder="ä¾‹å¦‚ï¼šJBSWY3DPEHPK3PXP"
              autocomplete="off"
              style="font-family: 'JetBrains Mono', monospace;"
            />
          </div>

          <div class="code-box">
            <div class="timer"><span data-i18n="twofa_timer">æ›´æ–°å€’è®¡æ—¶</span>ï¼š<span id="twofaCountdown">30</span>s</div>
            <div class="totp-display" id="totpCode" title="ç‚¹å‡»å¤åˆ¶">--- ---</div>
            <div id="twofaStatus" style="font-size: 11px; color:var(--ink-soft); margin-top:4px;">ç‚¹å‡»éªŒè¯ç å¤åˆ¶</div>
          </div>
        </div>

        <!-- OneKey å·¥å…· -->
        <div class="mini-card" style="border-left: 3px solid var(--accent-2);">
          <h3>
            <svg class="icon" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
            OneKey Batch
          </h3>
          <div class="field">
            <label for="onekeyApiKey" style="font-size:11px;">
              <span data-i18n="onekey_apikey_label">API Key (å¯é€‰ï¼Œç»•è¿‡éªŒè¯ç )</span>
            </label>
            <input
              id="onekeyApiKey"
              type="password"
              placeholder="hCaptcha API Key"
              style="font-size:12px;"
            />
            <textarea
              id="onekeyIds"
              rows="3"
              placeholder="verificationId"
              style="resize: none; margin-top:8px;"
            ></textarea>
            <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
              <input
                id="onekeyProgramId"
                type="text"
                placeholder="programId (å¯é€‰)"
                style="flex: 1;"
              />
              <label style="display:flex; align-items:center; gap:4px; margin:0; cursor:pointer;">
                <input id="onekeyUseLucky" type="checkbox" />
                <span data-i18n="onekey_useLucky" style="font-size:11px; text-transform:none;">Lucky</span>
              </label>
            </div>
            <button id="onekeyBatchBtn" class="secondary" style="margin-top:8px; width:100%;" data-i18n="onekey_btn">æ‰¹é‡éªŒè¯</button>
            <div id="onekeyResult" style="margin-top:8px; font-size:11px; color:var(--ink-soft); word-break:break-all;"></div>
          </div>
        </div>

        <!-- åˆ·æ–°æ§åˆ¶ -->
        <div class="controls">
          <div class="field" style="flex-direction: row; gap: 8px; align-items: flex-end;">
            <div style="flex:1;">
              <label for="refreshSeconds" data-i18n="refresh_label">è‡ªåŠ¨åˆ·æ–° (ç§’)</label>
              <input id="refreshSeconds" type="number" min="1" value="5" />
            </div>
            <button id="applyRefresh" class="secondary" style="height: 38px;">
              <span data-i18n="apply_refresh">è®¾ç½®</span>
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <button id="toggleAutoRefresh" class="secondary" data-active="true">
              <span data-i18n="auto_refresh_on">è‡ªåŠ¨åˆ·æ–°: å¼€</span>
            </button>
            <button id="manualRefresh" class="secondary">
              <span data-i18n="manual_refresh">åˆ·æ–°</span>
            </button>
            <button id="resetChecking" class="secondary">
              <span data-i18n="reset_checking">é‡ç½®</span>
            </button>
          </div>
          <div id="message"></div>
        </div>
      </section>

      <!-- å³ä¾§æ•°æ®å±•ç¤º -->
      <section class="panel">
        <div class="toolbar">
          <h2 style="margin:0;">
            <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            <span data-i18n="status_title">è´¦å·çŠ¶æ€</span>
          </h2>
          <button id="toggleSheeridView" class="secondary">
            <span data-i18n="view_sheerid">åˆ‡æ¢è§†å›¾</span>
          </button>
        </div>

        <div class="summary" id="summary"></div>

        <div id="accountsView" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
          <div class="toolbar">
            <div class="category-bar" id="categoryBar">
              <button class="cat-btn" data-cat="ALL" data-active="true" data-i18n="cat_all">å…¨éƒ¨</button>
              <button class="cat-btn" data-cat="QUALIFIED" data-i18n="cat_qualified">èµ„è´¨å·</button>
              <button class="cat-btn" data-cat="INVALID" data-i18n="cat_invalid">æ™®é€šå·</button>
              <button class="cat-btn" data-cat="FINISHED" data-i18n="cat_finished">æˆå“å·</button>
              <button class="cat-btn" data-cat="IDLE" data-i18n="cat_idle">IDLE</button>
            </div>
            
            <div class="toolbar-left" style="margin-left:auto;">
               <div id="selectedCount" style="align-self:center; font-size:12px; color:var(--ink-soft); margin-right:8px;"></div>
               <button id="exportSelectedBtn" class="secondary" style="padding:6px 10px; font-size:12px;" data-i18n="export_selected">å¯¼å‡ºé€‰ä¸­</button>
               <button id="resetSelectedBtn" class="secondary" style="padding:6px 10px; font-size:12px;" data-i18n="reset_selected">é‡ç½®é€‰ä¸­</button>
               <button id="setProductSelectedBtn" class="secondary" style="padding:6px 10px; font-size:12px;" data-i18n="set_product_selected">è®¾ä¸ºæˆå“å·</button>
               <button id="clearSelectionBtn" class="secondary" style="padding:6px 10px; font-size:12px;" data-i18n="clear_select">æ¸…ç©º</button>
            </div>
          </div>

        <div style="flex: 1; overflow-y: auto; border: 1px solid var(--line); border-radius: 12px; position:relative;">
            <table>
              <thead>
                <tr>
                  <th style="width: 40px; text-align: center;">
                    <input id="selectAll" type="checkbox" title="Select all" />
                  </th>
                  <th data-i18n="th_email">è´¦å·</th>
                  <th data-i18n="th_password">å¯†ç </th>
                  <th data-i18n="th_recovery_email">è¾…åŠ©é‚®ç®±</th>
                  <th data-i18n="th_2fa">2FA å¯†é’¥</th>
                  <th data-i18n="th_status">çŠ¶æ€</th>
                  <th data-i18n="th_sold">å‡ºå”®</th>
                  <th data-i18n="th_actions" style="text-align: right;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>

        <div id="sheeridView" style="display:none; flex:1; overflow-y:auto;">
          <div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:12px; color: var(--ink-soft); font-size: 13px;" data-i18n="sheerid_desc">
            åªæ˜¾ç¤ºå·²èµ„è´¨ï¼ˆQUALIFIEDï¼‰ä¸”æœ‰è®¤è¯é“¾æ¥çš„è´¦å·ã€‚
          </div>
          <table style="border: 1px solid var(--line); border-radius: 12px; overflow:hidden;">
            <thead>
              <tr>
                <th data-i18n="th_email">è´¦å·</th>
                <th data-i18n="th_sheerid">è®¤è¯é“¾æ¥</th>
                <th data-i18n="th_verify_status">éªŒè¯çŠ¶æ€</th>
                <th data-i18n="th_actions" style="text-align:right;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="sheeridTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      /* --- Icons Definitions (Inline SVG Strings for JS Injection) --- */
      const ICONS = {
        sun: `<svg viewBox="0 0 24 24" class="icon"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        moon: `<svg viewBox="0 0 24 24" class="icon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        export: `<svg class="icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
        trash: `<svg class="icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
        check: `<svg class="icon-sm" viewBox="0 0 24 24" style="margin:0;"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        x: `<svg class="icon-sm" viewBox="0 0 24 24" style="margin:0;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`
      };

      const messageEl = document.getElementById("message");
      const fileInput = document.getElementById("file");
      const fileHintEl = document.getElementById("fileHint");
      const templateSelect = document.getElementById("importTemplate");
      const templateHintEl = document.getElementById("templateHint");
      const modeHintEl = document.getElementById("modeHint");
      const importBtn = document.getElementById("importBtn");
      const applyRefreshBtn = document.getElementById("applyRefresh");
      const manualRefreshBtn = document.getElementById("manualRefresh");
      const resetCheckingBtn = document.getElementById("resetChecking");
      const refreshSecondsInput = document.getElementById("refreshSeconds");
      const tableBody = document.getElementById("tableBody");
      const toggleSheeridViewBtn = document.getElementById("toggleSheeridView");
      const accountsViewEl = document.getElementById("accountsView");
      const sheeridViewEl = document.getElementById("sheeridView");
      const sheeridTableBody = document.getElementById("sheeridTableBody");
      const summaryEl = document.getElementById("summary");
      const selectedCountEl = document.getElementById("selectedCount");
      const selectAllEl = document.getElementById("selectAll");
      const exportSelectedBtn = document.getElementById("exportSelectedBtn");
      const resetSelectedBtn = document.getElementById("resetSelectedBtn");
      const setProductSelectedBtn = document.getElementById("setProductSelectedBtn");
      const clearSelectionBtn = document.getElementById("clearSelectionBtn");
      const themeToggleBtn = document.getElementById("themeToggle");
      const langButtons = document.querySelectorAll(".lang-switch button[data-lang]");
      const categoryBar = document.getElementById("categoryBar");
      let refreshTimer = null;
      let currentLang = "zh";
      let editingEmail = null;
      let lastAccounts = [];
      const selectedEmails = new Set();
      let currentCategory = "ALL";

      const i18n = {
        zh: {
          page_title: "è´¦å·çŠ¶æ€é¢æ¿",
          title: "Account Pulse",
          subtitle: "å¯¼å…¥è´¦å·TXTæ–‡ä»¶ï¼Œç›‘æ§APIçŠ¶æ€å˜åŒ–ã€‚",
          import_title: "å¯¼å…¥ä¸åˆ·æ–°",
          file_label: "TXT æ–‡ä»¶",
          file_hint_none: "æœªé€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰",
          file_hint_count: (n) => `å·²é€‰æ‹© ${n} ä¸ªæ–‡ä»¶`,
          template_label: "å¯¼å…¥æ¨¡æ¿",
          template_auto: "è‡ªåŠ¨è¯†åˆ«",
          template_token: "è´¦å·;å¯†ç ;2FA å¯†é’¥",
          template_recovery: "è´¦å·;å¯†ç ;æ¢å¤é‚®ç®±",
          template_hint_auto: "è‡ªåŠ¨è¯†åˆ«ï¼š3åˆ—ä¸”ç¬¬3åˆ—åƒé‚®ç®±æ—¶è§†ä¸ºæ¢å¤é‚®ç®±ï¼Œå¦åˆ™è§†ä¸º 2FA å¯†é’¥ã€‚",
          template_hint_token: "æ¨¡æ¿ï¼šè´¦å·;å¯†ç ;2FA å¯†é’¥ï¼ˆå¯è¿½åŠ  4-6 åˆ—ï¼‰ã€‚",
          template_hint_recovery: "æ¨¡æ¿ï¼šè´¦å·;å¯†ç ;æ¢å¤é‚®ç®±ã€‚",
          mode_label: "å¯¼å…¥æ¨¡å¼",
          mode_overwrite: "è¦†ç›– (æ¸…ç©ºåå¯¼å…¥)",
          mode_append: "è¿½åŠ  (ä¿ç•™å¹¶æ·»åŠ )",
          mode_overwrite_disabled: "PostgreSQL æ¨¡å¼ä¸‹å·²ç¦ç”¨è¦†ç›–åŠŸèƒ½ã€‚",
          import_btn: "å¼€å§‹å¯¼å…¥",
          cat_all: "å…¨éƒ¨",
          cat_qualified: "èµ„è´¨å·",
          cat_invalid: "æ™®é€šå·",
          cat_finished: "æˆå“å·",
          cat_idle: "ç©ºé—²",
          onekey_title: "OneKey æ‰¹é‡éªŒè¯",
          onekey_btn: "æ‰¹é‡éªŒè¯",
          onekey_useLucky: "Lucky",
          onekey_apikey_label: "API Key (å¯é€‰ï¼Œç»•è¿‡éªŒè¯ç )",
          msg_onekey_too_many: "æœ€å¤šæ”¯æŒ 5 ä¸ª verificationId",
          msg_onekey_missing: "è¯·å¡«å†™ verificationId (æ¯è¡Œä¸€ä¸ª)",
          msg_onekey_running: "è¯·æ±‚ä¸­...",
          msg_onekey_fail: "è¯·æ±‚å¤±è´¥",
          msg_onekey_disabled: "ä¸å¯ç”¨",
          view_sheerid: "æŸ¥çœ‹é“¾æ¥",
          view_accounts: "æŸ¥çœ‹åˆ—è¡¨",
          sheerid_desc: "ä»…æ˜¾ç¤ºå·²é€šè¿‡èµ„è´¨ï¼ˆQUALIFIEDï¼‰çš„è®¤è¯é“¾æ¥ã€‚",
          twofa_title: "äºŒæ­¥éªŒè¯ (2FA)",
          twofa_desc: "è¾“å…¥å¯†é’¥ï¼Œå®æ—¶ç”ŸæˆéªŒè¯ç ã€‚",
          twofa_secret_label: "å¯†é’¥ (Secret Key)",
          twofa_timer: "åˆ·æ–°",
          twofa_note: "ç‚¹å‡»éªŒè¯ç å³å¯å¤åˆ¶",
          refresh_label: "è‡ªåŠ¨åˆ·æ–° (ç§’)",
          apply_refresh: "è®¾ç½®",
          manual_refresh: "åˆ·æ–°",
          auto_refresh_on: "è‡ªåŠ¨: å¼€",
          auto_refresh_off: "è‡ªåŠ¨: å…³",
          reset_checking: "é‡ç½®",
          status_title: "è´¦å·çŠ¶æ€",
          th_email: "è´¦å·",
          th_password: "å¯†ç ",
          th_recovery_email: "è¾…åŠ©é‚®ç®±",
          th_2fa: "2FA å¯†é’¥",
          th_sheerid: "è®¤è¯é“¾æ¥",
          th_verify_status: "éªŒè¯çŠ¶æ€",
          verify_btn: "éªŒè¯",
          th_status: "çŠ¶æ€",
          th_sold: "å‡ºå”®",
          th_finished: "æˆå“",
          th_actions: "æ“ä½œ",
          sold_yes: "å·²å”®",
          sold_no: "æœªå”®",
          finished_yes: "æ˜¯",
          finished_no: "å¦",
          summary_total: "æ€»æ•°",
          summary_idle: "ç©ºé—²",
          summary_checking: "æ£€æŸ¥ä¸­",
          summary_qualified: "åˆæ ¼",
          summary_invalid: "æ— æ•ˆ",
          summary_qualified_normal: "èµ„è´¨å·",
          summary_invalid_normal: "æ™®é€šå·",
          summary_finished_total: "æˆå“å·",
          status_finished_qualified: "æˆå“",
          status_finished_invalid: "æˆå“-æ— æ•ˆ",
          status_finished_suffix: "(æˆå“)",
          status_product: "æˆå“å·",
          msg_refreshed: "æ•°æ®å·²æ›´æ–°",
          msg_refresh_fail: "åˆ·æ–°å¤±è´¥",
          msg_file_missing: "è¯·å…ˆé€‰æ‹©æ–‡ä»¶",
          msg_import_done: (added, updated, skipped) =>
            `æˆåŠŸï¼šæ–°å¢ ${added}ï¼Œæ›´æ–° ${updated}ï¼Œè·³è¿‡ ${skipped}`,
          msg_import_fail: "å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶",
          msg_refresh_set: (seconds) => `åˆ·æ–°é—´éš”: ${seconds} ç§’`,
          msg_reset_done: (count) => `å·²é‡ç½® ${count} ä¸ªè´¦å·`,
          msg_reset_fail: "é‡ç½®å¤±è´¥",
          msg_reset_confirm: "ç¡®è®¤é‡ç½®æ‰€æœ‰æ£€æŸ¥ä¸­çŠ¶æ€ï¼Ÿ",
          msg_sold_updated: "å‡ºå”®çŠ¶æ€å·²æ›´æ–°",
          msg_sold_update_fail: "æ›´æ–°å¤±è´¥",
          delete_btn: "åˆ é™¤",
          msg_delete_confirm: "ç¡®è®¤æ°¸ä¹…åˆ é™¤æ­¤è´¦å·ï¼Ÿ",
          msg_delete_done: "è´¦å·å·²åˆ é™¤",
          msg_delete_fail: "åˆ é™¤å¤±è´¥",
          msg_sheerid_delete_confirm: "ç¡®è®¤åˆ é™¤è¯¥è´¦å·çš„è®¤è¯é“¾æ¥ï¼Ÿ",
          msg_sheerid_delete_done: "è®¤è¯é“¾æ¥å·²åˆ é™¤",
          msg_sheerid_delete_fail: "åˆ é™¤è®¤è¯é“¾æ¥å¤±è´¥",
          edit_hint: "åŒå‡»è¡Œå¯ç¼–è¾‘å†…å®¹",
          edit_save: "ä¿å­˜",
          edit_cancel: "å–æ¶ˆ",
          msg_edit_saved: "å·²ä¿å­˜",
          msg_edit_save_fail: "ä¿å­˜å¤±è´¥",
          export_btn: "å¯¼å‡º",
          msg_export_done: "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
          msg_export_fail: "å¤åˆ¶å¤±è´¥",
          export_selected: "å¯¼å‡ºé€‰ä¸­",
          reset_selected: "é‡ç½®é€‰ä¸­",
          set_product_selected: "è®¾ä¸ºæˆå“å·",
          clear_select: "æ¸…ç©º",
          selected_count: (n) => `${n} å·²é€‰`,
          msg_export_none: "æœªé€‰æ‹©è´¦å·",
          msg_reset_selected_none: "æœªé€‰æ‹©è´¦å·",
          msg_reset_selected_confirm: (n) => `ç¡®è®¤é‡ç½®é€‰ä¸­çš„ ${n} ä¸ªè´¦å·ä¸º IDLEï¼Ÿ`,
          msg_reset_selected_done: (n) => `å·²é‡ç½® ${n} ä¸ªè´¦å·`,
          msg_reset_selected_fail: "æ‰¹é‡é‡ç½®å¤±è´¥",
          msg_set_product_selected_none: "æœªé€‰æ‹©è´¦å·",
          msg_set_product_selected_confirm: (n) => `ç¡®è®¤å°†é€‰ä¸­çš„ ${n} ä¸ªè´¦å·è®¾ä¸º æˆå“å·ï¼Ÿ`,
          msg_set_product_selected_done: (n) => `å·²è®¾ç½® ${n} ä¸ªè´¦å·ä¸º æˆå“å·`,
          msg_set_product_selected_fail: "æ‰¹é‡è®¾ç½®å¤±è´¥",
          msg_status_updated: "çŠ¶æ€å·²æ›´æ–°",
          msg_status_update_fail: "æ›´æ–°çŠ¶æ€å¤±è´¥",
          msg_cell_copied: "å·²å¤åˆ¶",
          msg_cell_copy_fail: "å¤åˆ¶å¤±è´¥",
          theme_dark: "ğŸŒ™",
          theme_light: "â˜€ï¸",
          empty_table: "æš‚æ— æ•°æ®",
          empty_sheerid: "æš‚æ— é“¾æ¥",
        },
        en: {
          page_title: "Account Pulse",
          title: "Account Pulse",
          subtitle: "Import TXT accounts and track status changes regarding APIs.",
          import_title: "Import & Refresh",
          file_label: "TXT File",
          file_hint_none: "No file selected",
          file_hint_count: (n) => `${n} files selected`,
          template_label: "Import Template",
          template_auto: "Auto Detect",
          template_token: "Account;Password;2FA Token",
          template_recovery: "Account;Password;Recovery Email",
          template_hint_auto: "Auto: if 3 columns and column 3 looks like email -> recovery email, else 2FA token.",
          template_hint_token: "Template: account;password;2FA token (optional columns 4-6).",
          template_hint_recovery: "Template: account;password;recovery email.",
          mode_label: "Import Mode",
          mode_overwrite: "Overwrite (Clear & Import)",
          mode_append: "Append (Keep & Add)",
          mode_overwrite_disabled: "PostgreSQL active: overwrite disabled.",
          import_btn: "Start Import",
          cat_all: "All",
          cat_qualified: "Qualified",
          cat_invalid: "Normal",
          cat_finished: "Finished",
          cat_idle: "Idle",
          onekey_title: "OneKey Batch",
          onekey_btn: "Batch Verify",
          onekey_useLucky: "Lucky",
          onekey_apikey_label: "API Key (optional, bypass captcha)",
          msg_onekey_too_many: "Max 5 IDs",
          msg_onekey_missing: "Enter IDs first",
          msg_onekey_running: "Processing...",
          msg_onekey_fail: "Request Failed",
          msg_onekey_disabled: "Disabled",
          view_sheerid: "Links View",
          view_accounts: "List View",
          sheerid_desc: "Showing only QUALIFIED accounts with SheerID links.",
          twofa_title: "2FA Generator",
          twofa_desc: "Enter Secret Key to generate code.",
          twofa_secret_label: "Secret Key",
          twofa_timer: "Refresh",
          twofa_note: "Click code to copy",
          refresh_label: "Refresh Rate (s)",
          apply_refresh: "Set",
          manual_refresh: "Refresh",
          auto_refresh_on: "Auto: On",
          auto_refresh_off: "Auto: Off",
          reset_checking: "Reset",
          status_title: "Status",
          th_email: "Account",
          th_password: "Password",
          th_recovery_email: "Recovery Email",
          th_2fa: "2FA Token",
          th_sheerid: "SheerID Link",
          th_verify_status: "Verify Status",
          verify_btn: "Verify",
          th_status: "Status",
          th_sold: "Sold",
          th_finished: "Finished",
          th_actions: "Actions",
          sold_yes: "Yes",
          sold_no: "No",
          finished_yes: "Yes",
          finished_no: "No",
          summary_total: "Total",
          summary_idle: "Idle",
          summary_checking: "Checking",
          summary_qualified: "Qualified",
          summary_invalid: "Invalid",
          summary_qualified_normal: "Qualified",
          summary_invalid_normal: "Normal",
          summary_finished_total: "Finished",
          status_finished_qualified: "PRODUCT",
          status_finished_invalid: "FINISHED-INVALID",
          status_finished_suffix: "(Fin)",
          status_product: "PRODUCT",
          msg_refreshed: "Updated",
          msg_refresh_fail: "Update Failed",
          msg_file_missing: "Select a file first",
          msg_import_done: (added, updated, skipped) =>
            `Done: +${added}, ~${updated}, -${skipped}`,
          msg_import_fail: "Import Failed",
          msg_refresh_set: (seconds) => `Interval: ${seconds}s`,
          msg_reset_done: (count) => `Reset ${count} items`,
          msg_reset_fail: "Reset Failed",
          msg_reset_confirm: "Reset all checking items?",
          msg_sold_updated: "Sold status updated",
          msg_sold_update_fail: "Update failed",
          delete_btn: "Del",
          msg_delete_confirm: "Delete this account permanently?",
          msg_delete_done: "Deleted",
          msg_delete_fail: "Failed",
          msg_sheerid_delete_confirm: "Delete this account's SheerID link?",
          msg_sheerid_delete_done: "SheerID link deleted",
          msg_sheerid_delete_fail: "Failed to delete SheerID link",
          edit_hint: "Double click to edit",
          edit_save: "Save",
          edit_cancel: "Cancel",
          msg_edit_saved: "Saved",
          msg_edit_save_fail: "Error",
          export_btn: "Exp",
          msg_export_done: "Copied",
          msg_export_fail: "Copy Failed",
          export_selected: "Export Sel.",
          reset_selected: "Reset Sel.",
          set_product_selected: "Set PRODUCT",
          clear_select: "Clear",
          selected_count: (n) => `${n} selected`,
          msg_export_none: "None selected",
          msg_reset_selected_none: "None selected",
          msg_reset_selected_confirm: (n) => `Reset ${n} selected to IDLE?`,
          msg_reset_selected_done: (n) => `Reset ${n} items`,
          msg_reset_selected_fail: "Failed",
          msg_set_product_selected_none: "None selected",
          msg_set_product_selected_confirm: (n) => `Set ${n} selected to PRODUCT?`,
          msg_set_product_selected_done: (n) => `Set ${n} items to PRODUCT`,
          msg_set_product_selected_fail: "Failed",
          msg_status_updated: "Status updated",
          msg_status_update_fail: "Update failed",
          msg_cell_copied: "Copied",
          msg_cell_copy_fail: "Error",
          theme_dark: "Dark",
          theme_light: "Light",
          empty_table: "No data",
          empty_sheerid: "No links",
        },
      };

      function setMessage(text, tone = "info") {
        messageEl.textContent = text;
        messageEl.style.color = tone === "error" ? "var(--status-invalid-text)" : "var(--accent-2)";
        setTimeout(() => {
            if(messageEl.textContent === text) messageEl.textContent = "";
        }, 3000);
      }

      function getCurrentTheme() {
        return document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
      }

      function setTheme(theme, persist = true) {
        const normalized = theme === "dark" ? "dark" : "light";
        if (normalized === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
        } else {
          document.documentElement.removeAttribute("data-theme");
        }
        if (persist) {
          localStorage.setItem("theme", normalized);
        }
        updateThemeToggleIcon();
      }

      function updateThemeToggleIcon() {
        // Toggle between Sun and Moon Icons
        const isDark = getCurrentTheme() === "dark";
        themeToggleBtn.innerHTML = isDark ? ICONS.moon : ICONS.sun;
      }

      function getCurrentStatusView() {
        const v = (localStorage.getItem("status_view") || "ACCOUNTS").toUpperCase();
        return v === "SHEERID" ? "SHEERID" : "ACCOUNTS";
      }

      function setStatusView(view, persist = true) {
        const v = view === "SHEERID" ? "SHEERID" : "ACCOUNTS";
        if (persist) {
          localStorage.setItem("status_view", v);
        }
        const t = i18n[currentLang];
        // Note: We are updating text content here, keeping icons in HTML would require more complex logic
        // For simplicity, we just update the text and keep the icon static in HTML (eye icon)
        if (v === "SHEERID") {
          accountsViewEl.style.display = "none";
          sheeridViewEl.style.display = "block";
          toggleSheeridViewBtn.querySelector("span").textContent = t.view_accounts;
        } else {
          accountsViewEl.style.display = "flex";
          sheeridViewEl.style.display = "none";
          toggleSheeridViewBtn.querySelector("span").textContent = t.view_sheerid;
        }
        renderActiveView();
      }

      // SheerID SSE éªŒè¯å‡½æ•°
      async function verifySheeridSSE(verificationIds, onResult) {
        const apiKey = localStorage.getItem("onekey_api_key") || "";
        const programId = "";
        const useLucky = false;
        
        // é€šè¿‡åç«¯ä»£ç†è°ƒç”¨ï¼Œé¿å… CORS é—®é¢˜
        const resp = await fetch("/api/sheerid-verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ verificationIds, apiKey, useLucky, programId })
        });
        
        if (!resp.ok) throw new Error("Request failed: " + resp.status);
        
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          console.log("SSE chunk:", chunk); // è°ƒè¯•
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.startsWith("data:")) {
              const rawData = line.slice(5).trim();
              console.log("SSE data:", rawData); // è°ƒè¯•
              try {
                const data = JSON.parse(rawData);
                if (onResult) onResult(data);
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ•°æ®
                if (onResult && rawData) onResult({ message: rawData });
              }
            }
          }
        }
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          try {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          } catch {
            return false;
          }
        }
      }

      function updateSelectionUI() {
        const t = i18n[currentLang];
        selectedCountEl.textContent = t.selected_count(selectedEmails.size);
        const total = getFilteredAccounts().length;
        const selected = selectedEmails.size;
        selectAllEl.checked = total > 0 && selected === total;
        selectAllEl.indeterminate = selected > 0 && selected < total;
      }

      function getFilteredAccounts() {
        const list = Array.isArray(lastAccounts) ? lastAccounts : [];
        if (currentCategory === "QUALIFIED") {
          return list.filter((a) => a && a.status === "QUALIFIED");
        }
        if (currentCategory === "INVALID") {
          return list.filter((a) => a && a.status === "INVALID");
        }
        if (currentCategory === "FINISHED") {
          return list.filter((a) => a && a.status === "PRODUCT");
        }
        if (currentCategory === "IDLE") {
          return list.filter((a) => a && a.status === "IDLE");
        }
        return list;
      }

      function renderSummary(counts, total) {
        const t = i18n[currentLang];
        const qualifiedNormal = lastAccounts.filter((a) => a && a.status === "QUALIFIED").length;
        const invalidNormal = lastAccounts.filter((a) => a && a.status === "INVALID").length;
        const finishedTotal = lastAccounts.filter((a) => a && a.status === "PRODUCT").length;
        const items = [
          { label: t.summary_total, value: total },
          { label: t.summary_idle, value: counts.IDLE || 0 },
          { label: t.summary_checking, value: counts.CHECKING || 0 },
          { label: t.summary_qualified, value: counts.QUALIFIED || 0 },
          { label: t.summary_invalid, value: counts.INVALID || 0 },
          { label: t.summary_qualified_normal, value: qualifiedNormal },
          { label: t.summary_invalid_normal, value: invalidNormal },
          { label: t.summary_finished_total, value: finishedTotal },
        ];
        summaryEl.innerHTML = items
          .map(
            (item) =>
              `<div class="summary-card"><span>${item.label}</span><strong>${item.value}</strong></div>`
          )
          .join("");
      }

      function statusLabel(account) {
        const t = i18n[currentLang];
        const s = (account && account.status ? account.status : "").toString();
        if (s === "PRODUCT") {
          return t.status_product;
        }
        return s;
      }

      function statusChipClass(account) {
        const s = (account && account.status ? account.status : "").toString();
        return `status-chip ${s}`;
      }

      function getQualifiedSheeridAccounts() {
        const list = Array.isArray(lastAccounts) ? lastAccounts : [];
        return list.filter((a) => a && a.status === "QUALIFIED" && a.sheeridUrl && String(a.sheeridUrl).trim());
      }

      function renderSheeridTable(accounts) {
        const t = i18n[currentLang];
        if (!accounts || accounts.length === 0) {
          sheeridTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">${t.empty_sheerid}</td></tr>`;
          return;
        }
        sheeridTableBody.innerHTML = accounts
          .map((a) => {
            const url = String(a.sheeridUrl || "").trim();
            // ä» URL æå– verificationId
            const idMatch = url.match(/([a-f0-9]{24})/i);
            const verifyId = idMatch ? idMatch[1] : "";
            return `<tr data-email="${a.email}" data-verify-id="${verifyId}">
              <td class="copyable" data-copy-type="email" title="Click to copy">${a.email}</td>
              <td class="copyable sheerid-cell" data-copy-type="sheerid" data-email="${a.email}" title="Click to copy">${url}</td>
              <td class="verify-status" data-email="${a.email}" style="font-size:12px; color:var(--ink-soft);">-</td>
              <td style="text-align:right; white-space:nowrap;">
                <button class="secondary sheerid-verify-btn" data-email="${a.email}" data-verify-id="${verifyId}" style="padding:4px 8px;" ${!verifyId ? 'disabled' : ''}>
                  ${t.verify_btn || 'éªŒè¯'}
                </button>
                <button class="secondary sheerid-delete-btn" data-email="${a.email}" style="padding:4px 8px; color: var(--status-invalid-text); border-color: rgba(200,0,0,0.2);">
                  ${t.delete_btn}
                </button>
              </td>
            </tr>`;
          })
          .join("");

        sheeridTableBody.querySelectorAll(".copyable").forEach((el) => {
          el.addEventListener("click", async (event) => {
            event.stopPropagation();
            if (el.querySelector("input")) return;
            if (event.target.closest("button")) return;
            const type = el.getAttribute("data-copy-type");
            const row = el.closest("tr");
            let text = (el.textContent || "").trim();
            if (type === "email" && row) text = row.getAttribute("data-email") || text;
            if (!text) return;
            const ok = await copyText(text);
            if (ok) setMessage(i18n[currentLang].msg_cell_copied);
            else setMessage(i18n[currentLang].msg_cell_copy_fail, "error");
          });
        });

        // Double-click to edit SheerID link (no link opening; single click copies).
        sheeridTableBody.querySelectorAll(".sheerid-cell").forEach((cell) => {
          cell.addEventListener("dblclick", (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (cell.querySelector("input")) return;
            const email = cell.getAttribute("data-email");
            if (!email) return;
            const original = (cell.textContent || "").trim();

            const input = document.createElement("input");
            input.type = "text";
            input.value = original;
            input.style.width = "100%";
            input.style.padding = "6px 8px";
            input.style.borderRadius = "8px";
            input.style.border = "1px solid var(--line)";
            input.style.background = "var(--card)";
            input.style.color = "var(--ink)";

            cell.textContent = "";
            cell.appendChild(input);
            input.focus();
            input.select();

            const restore = () => {
              cell.textContent = original;
            };

            input.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                e.preventDefault();
                restore();
              }
              if (e.key === "Enter") {
                e.preventDefault();
                input.blur();
              }
            });

            input.addEventListener("blur", async () => {
              const next = (input.value || "").trim();
              if (next === original) {
                restore();
                return;
              }
              try {
                const resp = await fetch("/api/sheerid", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, sheeridUrl: next }),
                });
                if (!resp.ok) throw new Error("update sheerid failed");
                await fetchAccounts();
              } catch (e) {
                restore();
                setMessage(i18n[currentLang].msg_edit_save_fail, "error");
              }
            });
          });
        });

        sheeridTableBody.querySelectorAll(".sheerid-delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (event) => {
            event.preventDefault();
            event.stopPropagation();
            const email = btn.getAttribute("data-email");
            if (!email) return;
            if (!window.confirm(i18n[currentLang].msg_sheerid_delete_confirm)) return;
            try {
              const resp = await fetch("/api/sheerid", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, sheeridUrl: "" }),
              });
              if (!resp.ok) throw new Error("delete sheerid failed");
              setMessage(i18n[currentLang].msg_sheerid_delete_done);
              await fetchAccounts();
            } catch (e) {
              setMessage(i18n[currentLang].msg_sheerid_delete_fail, "error");
            }
          });
        });

        // éªŒè¯æŒ‰é’®äº‹ä»¶
        sheeridTableBody.querySelectorAll(".sheerid-verify-btn").forEach((btn) => {
          btn.addEventListener("click", async (event) => {
            event.preventDefault();
            event.stopPropagation();
            const email = btn.getAttribute("data-email");
            const verifyId = btn.getAttribute("data-verify-id");
            if (!verifyId) return;
            
            const statusCell = sheeridTableBody.querySelector(`.verify-status[data-email="${email}"]`);
            if (statusCell) statusCell.textContent = "éªŒè¯ä¸­...";
            btn.disabled = true;
            
            try {
              await verifySheeridSSE([verifyId], (result) => {
                if (statusCell) {
                  // å¼€å§‹äº‹ä»¶ï¼Œæ˜¾ç¤ºç­‰å¾…ä¸­
                  if (result.total !== undefined && !result.verificationId) {
                    statusCell.textContent = "ç­‰å¾…ç»“æœä¸­...";
                    statusCell.style.color = "var(--ink-soft)";
                    return;
                  }
                  // è¿›åº¦äº‹ä»¶ï¼Œç»§ç»­ç­‰å¾…
                  if (result.completed !== undefined && !result.verificationId) {
                    return;
                  }
                  // ç»“æœäº‹ä»¶ï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
                  if (result.verificationId === verifyId || result.message || result.currentStep) {
                    const msg = result.message || result.currentStep || result.status || JSON.stringify(result);
                    statusCell.textContent = msg;
                    statusCell.style.color = (result.currentStep === "success" || result.status === "success") 
                      ? "var(--status-qualified-text)" 
                      : "var(--status-invalid-text)";
                  }
                }
              });
            } catch (e) {
              if (statusCell) statusCell.textContent = "å¤±è´¥: " + e.message;
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      function renderActiveView() {
        const view = getCurrentStatusView();
        if (view === "SHEERID") {
          renderSheeridTable(getQualifiedSheeridAccounts());
          return;
        }
        renderTable(getFilteredAccounts());
      }

      function renderTable(accounts) {
        const t = i18n[currentLang];
          if (!accounts || accounts.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:var(--ink-soft);">${t.empty_table}</td></tr>`;
          updateSelectionUI();
          return;
        }

        const currentEmails = new Set(accounts.map((a) => a.email));
        Array.from(selectedEmails).forEach((e) => {
          if (!currentEmails.has(e)) selectedEmails.delete(e);
        });
        updateSelectionUI();

        tableBody.innerHTML = accounts
          .map(
            (account) => {
              const isEditing = editingEmail && account.email === editingEmail;
              if (isEditing) {
                return `<tr data-email="${account.email}" class="row-editing">
                <td style="text-align:center;">
                  <input type="checkbox" class="row-select" data-email="${account.email}" ${
                    selectedEmails.has(account.email) ? "checked" : ""
                  } />
                </td>
                <td>${account.email}</td>
                <td><input class="edit-password" type="text" value="${(account.password || "").replaceAll('"', "&quot;")}" /></td>
                <td>${account.recoveryEmail || ""}</td>
                <td><input class="edit-2fa" type="text" value="${(account.authenticatorToken || "").replaceAll('"', "&quot;")}" /></td>
                <td>
                  <select class="edit-status">
                    ${["IDLE", "CHECKING", "QUALIFIED", "INVALID", "PRODUCT"]
                      .map((s) => `<option value="${s}" ${s === account.status ? "selected" : ""}>${s}</option>`)
                      .join("")}
                  </select>
                </td>
                <td>
                  <label>
                    <input type="checkbox" class="sold-toggle" data-email="${account.email}" ${
                      account.sold ? "checked" : ""
                    } />
                  </label>
                </td>
                <td style="text-align:right;">
                  <button class="secondary edit-save" data-email="${account.email}" style="padding:4px 8px;" title="${t.edit_save}">${ICONS.check}</button>
                  <button class="secondary edit-cancel" data-email="${account.email}" style="padding:4px 8px;" title="${t.edit_cancel}">${ICONS.x}</button>
                </td>
              </tr>`;
              }
              return `<tr data-email="${account.email}">
                <td style="text-align:center;">
                  <input type="checkbox" class="row-select" data-email="${account.email}" ${
                    selectedEmails.has(account.email) ? "checked" : ""
                  } />
                </td>
                <td class="copyable" data-copy-type="email" title="Copy">${account.email}</td>
                <td class="copyable" data-copy-type="password" title="Copy">${account.password || ""}</td>
                <td class="copyable" data-copy-type="recovery" title="Copy">${account.recoveryEmail || ""}</td>
                <td class="copyable" data-copy-type="token" title="Copy" style="font-family:'JetBrains Mono'; font-size:12px;">${account.authenticatorToken || ""}</td>
                <td class="status-cell" data-email="${account.email}"><span class="${statusChipClass(account)}">${statusLabel(account)}</span></td>
                <td>
                   <input type="checkbox" class="sold-toggle" data-email="${account.email}" ${account.sold ? "checked" : ""} />
                </td>
                <td style="text-align:right; white-space:nowrap;">
                  <button class="secondary export-btn" data-email="${account.email}" style="padding:4px 8px;">${t.export_btn}</button>
                  <button class="secondary delete-btn" data-email="${account.email}" style="padding:4px 8px; color: var(--status-invalid-text); border-color: rgba(200,0,0,0.2);">${t.delete_btn}</button>
                </td>
              </tr>`;
            }
          )
          .join("");

        // Keep event listeners logic same as before...
        tableBody.querySelectorAll(".row-select").forEach((el) => {
          el.addEventListener("click", (e) => e.stopPropagation());
          el.addEventListener("change", (event) => {
            const input = event.target;
            const email = input.getAttribute("data-email");
            input.checked ? selectedEmails.add(email) : selectedEmails.delete(email);
            updateSelectionUI();
          });
        });

        tableBody.querySelectorAll(".copyable").forEach((el) => {
            el.addEventListener("click", async (event) => {
                event.stopPropagation();
                const type = el.getAttribute("data-copy-type");
                const row = el.closest("tr");
                let text = (el.textContent || "").trim();
                if (type === "email" && row) text = row.getAttribute("data-email") || text;
                if (!text) return;
                const ok = await copyText(text);
                if (ok) setMessage(i18n[currentLang].msg_cell_copied);
                else setMessage(i18n[currentLang].msg_cell_copy_fail, "error");
            });
        });

        async function updateAccountStatus(email, status) {
          const t = i18n[currentLang];
          try {
            const resp = await fetch("/api/status", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, status }),
            });
            if (!resp.ok) throw new Error("status failed");
            setMessage(t.msg_status_updated);
            await fetchAccounts();
          } catch (e) {
            setMessage(t.msg_status_update_fail, "error");
          }
        }

        tableBody.querySelectorAll(".status-cell").forEach((cell) => {
          cell.addEventListener("dblclick", (event) => {
            event.preventDefault(); event.stopPropagation();
            const email = cell.getAttribute("data-email");
            if (!email || cell.querySelector("select")) return;
            const current = (lastAccounts.find((a) => a && a.email === email)?.status || "IDLE").toString();
            const select = document.createElement("select");
            ["IDLE", "CHECKING", "QUALIFIED", "INVALID", "PRODUCT"].forEach((s) => {
              const opt = document.createElement("option");
              opt.value = s;
              opt.textContent = s;
              if (s === current) opt.selected = true;
              select.appendChild(opt);
            });
            const original = cell.innerHTML;
            cell.innerHTML = ""; cell.appendChild(select); select.focus();
            const cancel = () => { cell.innerHTML = original; };
            select.addEventListener("keydown", (e) => {
               if (e.key === "Escape") { e.preventDefault(); cancel(); }
               if (e.key === "Enter") { e.preventDefault(); select.blur(); }
            });
            select.addEventListener("change", async () => {
              const next = select.value || current; await updateAccountStatus(email, next);
            });
            select.addEventListener("blur", cancel);
          });
        });

        tableBody.querySelectorAll(".edit-status").forEach((el) => {
          el.addEventListener("change", async (event) => {
            event.stopPropagation();
            const row = el.closest("tr[data-email]");
            const email = row ? row.getAttribute("data-email") : null;
            if (!email) return;
            const status = el.value || "";
            if (!status) return;
            await updateAccountStatus(email, status);
          });
        });

        tableBody.querySelectorAll(".sold-toggle").forEach((el) => {
          el.addEventListener("change", async (event) => {
            const input = event.target;
            const email = input.getAttribute("data-email");
            const sold = input.checked;
            try {
              const resp = await fetch("/api/sold", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, sold }),
              });
              if (!resp.ok) throw new Error("update failed");
              setMessage(i18n[currentLang].msg_sold_updated);
              await fetchAccounts();
            } catch (e) {
              input.checked = !sold;
              setMessage(i18n[currentLang].msg_sold_update_fail, "error");
            }
          });
        });

        tableBody.querySelectorAll(".export-btn").forEach((el) => {
          el.addEventListener("click", async (event) => {
            event.preventDefault(); event.stopPropagation();
            const btn = event.target.closest(".export-btn");
            const email = btn.getAttribute("data-email");
            const row = btn.closest("tr");
            const passwordInput = row.querySelector(".edit-password");
            const tokenInput = row.querySelector(".edit-2fa");
            const password = passwordInput ? passwordInput.value : (row.children[2]?.textContent || "");
            const token = tokenInput ? tokenInput.value : (row.children[4]?.textContent || "");
            const text = `|${email}|${password}|${token}|`;
            const ok = await copyText(text);
            if (ok) setMessage(i18n[currentLang].msg_export_done);
            else setMessage(i18n[currentLang].msg_export_fail, "error");
          });
        });

        tableBody.querySelectorAll("tr[data-email]").forEach((row) => {
          row.addEventListener("dblclick", (event) => {
            const target = event.target;
            if (target.closest("button") || target.closest("input") || target.closest("label") || target.closest(".status-cell") || target.classList.contains("sold-toggle")) return;
            const email = row.getAttribute("data-email");
            editingEmail = email;
            setMessage(t.edit_hint);
            renderTable(accounts);
          });
        });

        tableBody.querySelectorAll(".edit-cancel").forEach((el) => {
          el.addEventListener("click", (event) => {
            event.preventDefault(); event.stopPropagation();
            editingEmail = null;
            renderTable(accounts);
          });
        });

        tableBody.querySelectorAll(".edit-save").forEach((el) => {
          el.addEventListener("click", async (event) => {
            event.preventDefault(); event.stopPropagation();
            const email = el.getAttribute("data-email");
            const row = el.closest("tr");
            const password = row.querySelector(".edit-password").value || "";
            const authenticatorToken = row.querySelector(".edit-2fa").value || "";
            const status = row.querySelector(".edit-status")?.value || "";
            try {
              const content = `${email};${password};${authenticatorToken}\n`;
              const resp = await fetch("/api/import", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ mode: "APPEND", content, template: "TOKEN" }),
              });
              if (!resp.ok) throw new Error("save failed");
              if (status) await fetch("/api/status", {
                  method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, status })
              });
              editingEmail = null;
              setMessage(t.msg_edit_saved);
              await fetchAccounts();
            } catch (e) {
              setMessage(t.msg_edit_save_fail, "error");
            }
          });
        });

        tableBody.querySelectorAll(".delete-btn").forEach((el) => {
          el.addEventListener("click", async (event) => {
            const btn = event.target.closest(".delete-btn");
            const email = btn.getAttribute("data-email");
            if (!window.confirm(i18n[currentLang].msg_delete_confirm)) return;
            try {
              const resp = await fetch("/api/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
              });
              if (!resp.ok) throw new Error("delete failed");
              setMessage(i18n[currentLang].msg_delete_done);
              await fetchAccounts();
            } catch (e) {
              setMessage(i18n[currentLang].msg_delete_fail, "error");
            }
          });
        });
      }

      async function fetchAccounts() {
        try {
          const response = await fetch("/api/accounts");
          if (!response.ok) throw new Error("Load failed");
          const data = await response.json();
          lastAccounts = data.accounts || [];
          renderSummary(data.counts || {}, data.total || 0);
          renderActiveView();
        } catch (error) {
          setMessage(i18n[currentLang].msg_refresh_fail, "error");
        }
      }

      function scheduleRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        const seconds = Number(refreshSecondsInput.value) || 5;
        refreshTimer = setInterval(fetchAccounts, seconds * 1000);
        setMessage(i18n[currentLang].msg_refresh_set(seconds));
      }

      function updateFileHint() {
        if (!fileHintEl) return;
        const files = Array.from(fileInput.files || []);
        const t = i18n[currentLang];
        fileHintEl.textContent = files.length === 0 ? t.file_hint_none : t.file_hint_count(files.length);
      }

      function updateTemplateHint() {
        if (!templateHintEl || !templateSelect) return;
        const t = i18n[currentLang];
        const value = templateSelect.value || "AUTO";
        if (value === "RECOVERY_EMAIL") {
          templateHintEl.textContent = t.template_hint_recovery;
          return;
        }
        if (value === "TOKEN") {
          templateHintEl.textContent = t.template_hint_token;
          return;
        }
        templateHintEl.textContent = t.template_hint_auto;
      }

      async function syncImportModeCapabilities() {
        if (!modeHintEl) return;
        modeHintEl.textContent = "";
        try {
          const resp = await fetch("/api/info");
          if (!resp.ok) return;
          const info = await resp.json();
          const storage = info && info.storage ? String(info.storage) : "";
          const allowOverwrite = !!(info && info.pgAllowOverwrite);
          const overwriteRadio = document.querySelector('input[name="mode"][value="OVERWRITE"]');
          if (!overwriteRadio) return;
          if (storage === "postgres" && !allowOverwrite) {
            overwriteRadio.disabled = true;
            if (overwriteRadio.checked) {
              const appendRadio = document.querySelector('input[name="mode"][value="APPEND"]');
              if (appendRadio) appendRadio.checked = true;
            }
            modeHintEl.textContent = i18n[currentLang].mode_overwrite_disabled;
          }
        } catch {}
      }

      importBtn.addEventListener("click", async () => {
        const files = Array.from(fileInput.files || []);
        if (files.length === 0) {
          setMessage(i18n[currentLang].msg_file_missing, "error");
          return;
        }
        importBtn.disabled = true;
        try {
          const selectedMode = document.querySelector("input[name='mode']:checked").value;
          const selectedTemplate = templateSelect ? templateSelect.value : "AUTO";
          let totalAdded = 0, totalUpdated = 0, totalSkipped = 0;
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const content = await file.text();
            const mode = i === 0 ? selectedMode : selectedMode === "OVERWRITE" ? "APPEND" : selectedMode;
            const response = await fetch("/api/import", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mode, content, template: selectedTemplate }),
            });
            if (!response.ok) throw new Error(`å¯¼å…¥å¤±è´¥: ${file.name}`);
            const result = await response.json();
            totalAdded += Number(result.added || 0);
            totalUpdated += Number(result.updated || 0);
            totalSkipped += Number(result.skipped || 0);
          }
          setMessage(i18n[currentLang].msg_import_done(totalAdded, totalUpdated, totalSkipped));
          await fetchAccounts();
        } catch (error) {
          setMessage(i18n[currentLang].msg_import_fail, "error");
        } finally {
          importBtn.disabled = false;
        }
      });

      fileInput.addEventListener("change", updateFileHint);
      if (templateSelect) {
        templateSelect.addEventListener("change", updateTemplateHint);
      }

      // 2FA Logic
      const twofaSecretInput = document.getElementById("twofaSecret");
      const totpCodeEl = document.getElementById("totpCode");
      const twofaCountdownEl = document.getElementById("twofaCountdown");
      const twofaStatusEl = document.getElementById("twofaStatus");

      function normalizeBase32(secret) {
        return (secret || "").toUpperCase().replace(/[\s\-]/g, "").trim();
      }
      function refreshTwoFa() {
        const secretStr = normalizeBase32(twofaSecretInput.value);
        const now = Date.now();
        const period = 30;
        const remaining = period - Math.floor((now / 1000) % period);
        twofaCountdownEl.textContent = String(remaining);
        if (!secretStr) { totpCodeEl.textContent = "--- ---"; return; }
        try {
          const totp = new OTPAuth.TOTP({ issuer: 'Local', label: 'Account', algorithm: 'SHA1', digits: 6, period: period, secret: OTPAuth.Secret.fromBase32(secretStr) });
          const token = totp.generate();
          totpCodeEl.textContent = token.slice(0, 3) + " " + token.slice(3);
          if (twofaStatusEl.innerText !== "å·²å¤åˆ¶" && twofaStatusEl.innerText !== "Copied") {
             twofaStatusEl.innerText = i18n[currentLang].twofa_note;
          }
        } catch (e) {
          totpCodeEl.textContent = "ERROR";
          twofaStatusEl.innerText = "å¯†é’¥æ— æ•ˆ";
        }
      }
      twofaSecretInput.addEventListener("input", () => { twofaStatusEl.innerText = "-"; refreshTwoFa(); });
      totpCodeEl.addEventListener("click", async () => {
        const text = totpCodeEl.textContent.replace(/\s/g, "");
        if (!text || text === "------" || text === "ERROR") return;
        try {
          await navigator.clipboard.writeText(text);
          const oldText = twofaStatusEl.innerText;
          twofaStatusEl.innerText = i18n[currentLang].msg_cell_copied;
          setTimeout(() => { twofaStatusEl.innerText = oldText; }, 1000);
        } catch {}
      });
      setInterval(refreshTwoFa, 1000); refreshTwoFa();

      selectAllEl.addEventListener("change", () => {
        if (selectAllEl.checked) getFilteredAccounts().forEach((a) => selectedEmails.add(a.email));
        else getFilteredAccounts().forEach((a) => selectedEmails.delete(a.email));
        renderActiveView();
      });
      clearSelectionBtn.addEventListener("click", () => { selectedEmails.clear(); renderActiveView(); });
      exportSelectedBtn.addEventListener("click", async () => {
        const t = i18n[currentLang];
        const chosen = lastAccounts.filter((a) => selectedEmails.has(a.email));
        if (chosen.length === 0) { setMessage(t.msg_export_none, "error"); return; }
        const lines = chosen.map((a) => {
          const row = tableBody.querySelector(`tr[data-email="${a.email}"]`);
          const pwInput = row ? row.querySelector(".edit-password") : null;
          const tokInput = row ? row.querySelector(".edit-2fa") : null;
          const pw = pwInput ? pwInput.value : a.password || "";
          const tok = tokInput ? tokInput.value : a.authenticatorToken || "";
          return `|${a.email}|${pw}|${tok}|`;
        });
        if (await copyText(lines.join("\n"))) setMessage(t.msg_export_done);
        else setMessage(t.msg_export_fail, "error");
      });
      resetSelectedBtn.addEventListener("click", async () => {
        const t = i18n[currentLang];
        const emails = Array.from(selectedEmails);
        if (emails.length === 0) { setMessage(t.msg_reset_selected_none, "error"); return; }
        if (!window.confirm(t.msg_reset_selected_confirm(emails.length))) return;
        try {
          const resp = await fetch("/api/restore-statuses", {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ items: emails.map((email) => ({ email, status: "IDLE" })) }),
          });
          if (!resp.ok) throw new Error("bulk reset failed");
          setMessage(t.msg_reset_selected_done(emails.length));
          await fetchAccounts();
        } catch (e) { setMessage(t.msg_reset_selected_fail, "error"); }
      });

      if (setProductSelectedBtn) {
        setProductSelectedBtn.addEventListener("click", async () => {
          const t = i18n[currentLang];
          const emails = Array.from(selectedEmails);
          if (emails.length === 0) { setMessage(t.msg_set_product_selected_none, "error"); return; }
          if (!window.confirm(t.msg_set_product_selected_confirm(emails.length))) return;
          try {
            const resp = await fetch("/api/restore-statuses", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ items: emails.map((email) => ({ email, status: "PRODUCT" })) }),
            });
            if (!resp.ok) throw new Error("bulk set product failed");
            setMessage(t.msg_set_product_selected_done(emails.length));
            await fetchAccounts();
          } catch (e) {
            setMessage(t.msg_set_product_selected_fail, "error");
          }
        });
      }

      applyRefreshBtn.addEventListener("click", scheduleRefresh);
      manualRefreshBtn.addEventListener("click", fetchAccounts);
      
      // è‡ªåŠ¨åˆ·æ–°å¼€å…³
      const toggleAutoRefreshBtn = document.getElementById("toggleAutoRefresh");
      let autoRefreshEnabled = true;
      
      function updateAutoRefreshBtn() {
        const t = i18n[currentLang];
        const span = toggleAutoRefreshBtn.querySelector("span");
        if (autoRefreshEnabled) {
          span.textContent = t.auto_refresh_on;
          toggleAutoRefreshBtn.style.background = "var(--accent)";
          toggleAutoRefreshBtn.style.color = "#fff";
        } else {
          span.textContent = t.auto_refresh_off;
          toggleAutoRefreshBtn.style.background = "";
          toggleAutoRefreshBtn.style.color = "";
        }
      }
      
      toggleAutoRefreshBtn.addEventListener("click", () => {
        autoRefreshEnabled = !autoRefreshEnabled;
        if (autoRefreshEnabled) {
          scheduleRefresh();
        } else {
          if (refreshTimer) clearInterval(refreshTimer);
          refreshTimer = null;
        }
        updateAutoRefreshBtn();
      });
      
      resetCheckingBtn.addEventListener("click", async () => {
        if (!window.confirm(i18n[currentLang].msg_reset_confirm)) return;
        try {
          const response = await fetch("/api/reset-checking", { method: "POST" });
          if (!response.ok) throw new Error("reset failed");
          const text = await response.text();
          const count = Number(text.split(":")[1]) || 0;
          setMessage(i18n[currentLang].msg_reset_done(count));
          await fetchAccounts();
        } catch (error) { setMessage(i18n[currentLang].msg_reset_fail, "error"); }
      });

      function applyLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang === "zh" ? "zh-CN" : "en";
        document.title = i18n[currentLang].page_title;
        document.querySelectorAll("[data-i18n]").forEach((node) => {
          const key = node.getAttribute("data-i18n");
          if (i18n[currentLang][key]) node.textContent = i18n[currentLang][key];
        });
        updateFileHint(); updateTemplateHint(); syncImportModeCapabilities(); syncCategoryBar();
        renderSummary({}, 0); fetchAccounts(); setStatusView(getCurrentStatusView(), false);
      }

      function syncCategoryBar() {
        if (!categoryBar) return;
        categoryBar.querySelectorAll(".cat-btn").forEach((btn) => {
          btn.setAttribute("data-active", btn.getAttribute("data-cat") === currentCategory ? "true" : "false");
        });
      }
      if (categoryBar) {
        categoryBar.querySelectorAll(".cat-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            currentCategory = btn.getAttribute("data-cat") || "ALL";
            syncCategoryBar(); renderActiveView();
          });
        });
      }
      langButtons.forEach((btn) => {
        btn.addEventListener("click", () => applyLanguage(btn.getAttribute("data-lang")));
      });
      themeToggleBtn.addEventListener("click", () => {
        const next = getCurrentTheme() === "dark" ? "light" : "dark";
        setTheme(next, true);
      });
      if (toggleSheeridViewBtn) {
        toggleSheeridViewBtn.addEventListener("click", () => {
          const next = getCurrentStatusView() === "SHEERID" ? "ACCOUNTS" : "SHEERID";
          setStatusView(next);
        });
      }

      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) { setTheme(savedTheme, false); }
      else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) { setTheme("dark", false); }
      else { setTheme("light", false); }

      // OneKey Batch åŠŸèƒ½
      const onekeyBatchBtn = document.getElementById("onekeyBatchBtn");
      const onekeyIdsEl = document.getElementById("onekeyIds");
      const onekeyProgramIdEl = document.getElementById("onekeyProgramId");
      const onekeyUseLuckyEl = document.getElementById("onekeyUseLucky");
      const onekeyResultEl = document.getElementById("onekeyResult");
      const onekeyApiKeyEl = document.getElementById("onekeyApiKey");
      
      // åŠ è½½ä¿å­˜çš„ API Key
      if (onekeyApiKeyEl) {
        onekeyApiKeyEl.value = localStorage.getItem("onekey_api_key") || "";
        onekeyApiKeyEl.addEventListener("change", () => {
          localStorage.setItem("onekey_api_key", onekeyApiKeyEl.value.trim());
        });
      }
      
      if (onekeyBatchBtn) {
        onekeyBatchBtn.addEventListener("click", async () => {
          const t = i18n[currentLang];
          const raw = (onekeyIdsEl.value || "").trim();
          if (!raw) { onekeyResultEl.textContent = t.msg_onekey_missing; return; }
          
          // ä»è¾“å…¥ä¸­æå– verificationIdï¼ˆæ”¯æŒç›´æ¥ ID æˆ– URLï¼‰
          const lines = raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
          const ids = lines.map(line => {
            const match = line.match(/([a-f0-9]{24})/i);
            return match ? match[1] : null;
          }).filter(Boolean);
          
          if (ids.length === 0) { onekeyResultEl.textContent = t.msg_onekey_missing; return; }
          if (ids.length > 5) { onekeyResultEl.textContent = t.msg_onekey_too_many; return; }
          
          const programId = (onekeyProgramIdEl.value || "").trim();
          const useLucky = onekeyUseLuckyEl.checked;
          const apiKey = (onekeyApiKeyEl ? onekeyApiKeyEl.value.trim() : "") || localStorage.getItem("onekey_api_key") || "";
          
          onekeyResultEl.textContent = t.msg_onekey_running;
          onekeyBatchBtn.disabled = true;
          
          try {
            // å…ˆè·å– CSRF token
            const pageResp = await fetch("https://batch.1key.me/", { mode: "cors", credentials: "omit" });
            const pageHtml = await pageResp.text();
            const csrfMatch = pageHtml.match(/window\.CSRF_TOKEN\s*=\s*"([^"]+)"/);
            const csrfToken = csrfMatch ? csrfMatch[1] : "";
            
            if (!csrfToken) {
              onekeyResultEl.textContent = "Failed to get CSRF token";
              onekeyBatchBtn.disabled = false;
              return;
            }
            
            // SSE è¯·æ±‚
            const resp = await fetch("https://batch.1key.me/api/batch", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": csrfToken,
              },
              body: JSON.stringify({
                verificationIds: ids,
                hCaptchaToken: apiKey,
                useLucky: useLucky,
                programId: programId
              })
            });
            
            if (!resp.ok) throw new Error("Request failed");
            
            // è§£æ SSE å“åº”
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let result = "";
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split("\n");
              for (const line of lines) {
                if (line.startsWith("data:")) {
                  const data = line.slice(5).trim();
                  if (data) {
                    result += data + "\n";
                    onekeyResultEl.textContent = result;
                  }
                }
              }
            }
            
            if (!result) onekeyResultEl.textContent = "No response";
          } catch (e) {
            onekeyResultEl.textContent = t.msg_onekey_fail + ": " + e.message;
          } finally {
            onekeyBatchBtn.disabled = false;
          }
        });
      }

      applyLanguage(currentLang);
      scheduleRefresh();
    </script>
  </body>
</html>
